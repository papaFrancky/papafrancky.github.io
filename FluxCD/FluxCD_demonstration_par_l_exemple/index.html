
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../FlucCD_arborescence_par_produit/">
      
      
        <link rel="next" href="../../GKE/cluster_GKE_SSL_load-balancer/">
      
      
      <link rel="icon" href="../../images/poo.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>FluxCD - DÃ©monstration par l'exemple - Papa Francky's HowTos</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');}</style>


  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 13h-4v4h-2v-4H7v-2h4V7h2v4h4m-5-9A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2Z"/></svg>');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fluxcd-demonstration-par-lexemple" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Papa Francky&#39;s HowTos" class="md-header__button md-logo" aria-label="Papa Francky's HowTos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M268.9.9c-5.5-.7-11 1.4-14.5 5.7s-4.6 10.1-2.8 15.4c2.8 8.2 4.3 16.9 4.3 26.1 0 44.1-35.7 79.9-79.8 80H160c-35.3 0-64 28.7-64 64 0 19.1 8.4 36.3 21.7 48H104c-39.8 0-72 32.2-72 72 0 23.2 11 43.8 28 57-34.1 5.7-60 35.3-60 71 0 39.8 32.2 72 72 72h368c39.8 0 72-32.2 72-72 0-35.7-25.9-65.3-60-71 17-13.2 28-33.8 28-57 0-39.8-32.2-72-72-72h-13.7c13.3-11.7 21.7-28.9 21.7-48 0-35.3-28.7-64-64-64h-5.5c3.5-10 5.5-20.8 5.5-32 0-48.6-36.2-88.8-83.1-95.1zM192 256a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm96 32a32 32 0 1 1 64 0 32 32 0 1 1-64 0zm64 108.3c0 2.4-.7 4.8-2.2 6.7-8.2 10.5-39.5 45-93.8 45s-85.6-34.6-93.8-45c-1.5-1.9-2.2-4.3-2.2-6.7 0-6.8 5.5-12.3 12.3-12.3h167.4c6.8 0 12.3 5.5 12.3 12.3z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Papa Francky's HowTos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              FluxCD - DÃ©monstration par l'exemple
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Papa Francky&#39;s HowTos" class="md-nav__button md-logo" aria-label="Papa Francky's HowTos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M268.9.9c-5.5-.7-11 1.4-14.5 5.7s-4.6 10.1-2.8 15.4c2.8 8.2 4.3 16.9 4.3 26.1 0 44.1-35.7 79.9-79.8 80H160c-35.3 0-64 28.7-64 64 0 19.1 8.4 36.3 21.7 48H104c-39.8 0-72 32.2-72 72 0 23.2 11 43.8 28 57-34.1 5.7-60 35.3-60 71 0 39.8 32.2 72 72 72h368c39.8 0 72-32.2 72-72 0-35.7-25.9-65.3-60-71 17-13.2 28-33.8 28-57 0-39.8-32.2-72-72-72h-13.7c13.3-11.7 21.7-28.9 21.7-48 0-35.3-28.7-64-64-64h-5.5c3.5-10 5.5-20.8 5.5-32 0-48.6-36.2-88.8-83.1-95.1zM192 256a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm96 32a32 32 0 1 1 64 0 32 32 0 1 1-64 0zm64 108.3c0 2.4-.7 4.8-2.2 6.7-8.2 10.5-39.5 45-93.8 45s-85.6-34.6-93.8-45c-1.5-1.9-2.2-4.3-2.2-6.7 0-6.8 5.5-12.3 12.3-12.3h167.4c6.8 0 12.3 5.5 12.3 12.3z"/></svg>

    </a>
    Papa Francky's HowTos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MkDocs cheatsheet
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    000 setup
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            000 setup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../000_setup/Command_line_tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Command Line Tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../000_setup/Kubernetes_en_local/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes en local
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Docker
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Docker
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Docker/build_pull_image_on_dockerhub/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CrÃ©er et publier une image sur DockerHub
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    FluxCD
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            FluxCD
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../FlucCD_arborescence_par_produit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FluxCD - Proposition de nouvelle organisation des manifests
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    FluxCD - DÃ©monstration par l'exemple
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    FluxCD - DÃ©monstration par l'exemple
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#abstract" class="md-nav__link">
    <span class="md-ellipsis">
      Abstract
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requis" class="md-nav__link">
    <span class="md-ellipsis">
      PrÃ©-requis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PrÃ©-requis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation-de-notre-environnement-de-travail-en-local" class="md-nav__link">
    <span class="md-ellipsis">
      PrÃ©paration de notre environnement de travail en local
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-des-depots-github" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation des dÃ©pÃ´ts GitHub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clonage-des-depots-en-local" class="md-nav__link">
    <span class="md-ellipsis">
      Clonage des dÃ©pÃ´ts en local
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrap-de-fluxcd" class="md-nav__link">
    <span class="md-ellipsis">
      Bootstrap de FluxCD
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gestion-automatique-des-deploiements-dapplications-par-fluxcd" class="md-nav__link">
    <span class="md-ellipsis">
      Gestion automatique des dÃ©ploiements d'applications par FluxCD
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gestion automatique des dÃ©ploiements d'applications par FluxCD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#namespaces-dedies-a-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      Namespaces dÃ©diÃ©s Ã  l'application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#depot-github-dedie-aux-applications" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©pÃ´t GitHub dÃ©diÃ© aux applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-des-gitrepository-de-chacune-de-nos-applications" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©finition des GitRepository de chacune de nos applications
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DÃ©finition des GitRepository de chacune de nos applications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-des-deploy-keys" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation des 'Deploy Keys'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ajout-de-la-cle-publique-sur-le-depot-github" class="md-nav__link">
    <span class="md-ellipsis">
      Ajout de la clÃ© publique sur le dÃ©pÃ´t GitHub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-du-gitrepository-k8s-kind-apps-pour-chacune-des-applications" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©finition du GitRepository "k8s-kind-apps" pour chacune des applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-des-kustomizations-pour-chacun-des-gitrepositories" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©finition des 'Kustomizations' pour chacun des GitRepositories
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagerepository" class="md-nav__link">
    <span class="md-ellipsis">
      ImageRepository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagepolicy" class="md-nav__link">
    <span class="md-ellipsis">
      ImagePolicy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#marquage-des-manifests-de-deploiement-de-de-foo-et-bar" class="md-nav__link">
    <span class="md-ellipsis">
      Marquage des manifests de dÃ©ploiement de de 'foo' et 'bar'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#image-update-automation" class="md-nav__link">
    <span class="md-ellipsis">
      Image Update Automation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exposition-des-applications" class="md-nav__link">
    <span class="md-ellipsis">
      Exposition des applications
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notifications-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Notifications Discord
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notifications Discord">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation-du-client-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Installation du client 'Discord'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-dun-serveur-et-dun-channel-pour-chaque-application" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un 'serveur' et d'un 'channel' pour chaque application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CrÃ©ation d'un 'serveur' et d'un 'channel' pour chaque application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creation-dun-serveur-discord" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un serveur Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-dun-salon-dans-notre-serveur-discord" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un salon dans notre serveur Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-dun-webhook-pour-chaque-salon" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un 'webhook' pour chaque salon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enregistrement-des-webhook-des-salons-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Enregistrement des webhook des salons Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-des-notification-providers" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation des 'notification providers'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-des-alertes-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration des alertes Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activation-des-alertes-et-notifications" class="md-nav__link">
    <span class="md-ellipsis">
      Activation des alertes et notifications
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Activation des alertes et notifications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mise-en-place" class="md-nav__link">
    <span class="md-ellipsis">
      Mise en place
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests" class="md-nav__link">
    <span class="md-ellipsis">
      Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollback" class="md-nav__link">
    <span class="md-ellipsis">
      Rollback
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    GKE
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            GKE
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    cluster GKE SSL load balancer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            cluster GKE SSL load balancer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../GKE/cluster_GKE_SSL_load-balancer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cluster GKE en mode autopilot, load-balancer HTTPS et application 'stateless'
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    cluster GKE Wordpress CloudSQL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            cluster GKE Wordpress CloudSQL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../GKE/cluster_GKE_Wordpress_CloudSQL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploy WordPress on GKE with Persistent Disk and Cloud SQL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Dkt upgrade cluster gke
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Dkt upgrade cluster gke
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../GKE/dkt_upgrade_cluster_gke/readme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mise Ã  jour des clusters Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    terraform GKE cluster
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            terraform GKE cluster
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../GKE/terraform_GKE_cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Minikube
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Minikube
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Minikube/minikube_nginx_controller_macos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Minikube et l'ingress Nginx sur macOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus on minikube from scratch
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            Prometheus on minikube from scratch
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Minikube/prometheus_on_minikube_from_scratch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prometheus on MiniKube from scratch
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus and Grafana
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Prometheus and Grafana
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Prometheus_and_Grafana/kube-prometheus-stack_managed_with_fluxcd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    'kube-prometheus-stack' managed with FluxCD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Prometheus_and_Grafana/prometheus_grafana_on_k8s/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prometheus &amp; Grafana on Kubernetes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vault
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Vault
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cluster minikube vault with raft storage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            Cluster minikube vault with raft storage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Vault/cluster_minikube_vault_with_raft_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cluster [kind|minikube] - HashiCorp Vault with Raft integrated storage
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Helm vault auto unseal
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            Helm vault auto unseal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Vault/helm_vault_auto-unseal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Auto-unsealed Vault Helm deployment managed with FluxCD
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    kind helm vault auto unseal ESO
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            kind helm vault auto unseal ESO
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Vault/kind_helm_vault_auto-unseal_ESO/kind_vault_auto-unsealed_eso_fluxcd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DÃ©ploiement de Vault (auto-unsealed) et ESO via FluxCD sur un cluster KinD
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Kind vault external secrets operator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            Kind vault external secrets operator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Vault/kind_vault_external_secrets_operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kind - Vault - External-secrets operator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Vault/kind_vault_external_secrets_operator/README.2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kind - Vault - External-secrets operator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5" >
        
          
          <label class="md-nav__link" for="__nav_8_5" id="__nav_8_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    protect secrets using Vault and External Secrets Operator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_5">
            <span class="md-nav__icon md-icon"></span>
            protect secrets using Vault and External Secrets Operator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Vault/protect_secrets_using_Vault_and_External_Secrets_Operator/readme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Protect the secrets of your application using HashiCorp Vault and the External Secrets Operator (ESO)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#abstract" class="md-nav__link">
    <span class="md-ellipsis">
      Abstract
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requis" class="md-nav__link">
    <span class="md-ellipsis">
      PrÃ©-requis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PrÃ©-requis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparation-de-notre-environnement-de-travail-en-local" class="md-nav__link">
    <span class="md-ellipsis">
      PrÃ©paration de notre environnement de travail en local
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-des-depots-github" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation des dÃ©pÃ´ts GitHub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clonage-des-depots-en-local" class="md-nav__link">
    <span class="md-ellipsis">
      Clonage des dÃ©pÃ´ts en local
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bootstrap-de-fluxcd" class="md-nav__link">
    <span class="md-ellipsis">
      Bootstrap de FluxCD
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gestion-automatique-des-deploiements-dapplications-par-fluxcd" class="md-nav__link">
    <span class="md-ellipsis">
      Gestion automatique des dÃ©ploiements d'applications par FluxCD
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gestion automatique des dÃ©ploiements d'applications par FluxCD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#namespaces-dedies-a-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      Namespaces dÃ©diÃ©s Ã  l'application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#depot-github-dedie-aux-applications" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©pÃ´t GitHub dÃ©diÃ© aux applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-des-gitrepository-de-chacune-de-nos-applications" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©finition des GitRepository de chacune de nos applications
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DÃ©finition des GitRepository de chacune de nos applications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-des-deploy-keys" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation des 'Deploy Keys'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ajout-de-la-cle-publique-sur-le-depot-github" class="md-nav__link">
    <span class="md-ellipsis">
      Ajout de la clÃ© publique sur le dÃ©pÃ´t GitHub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-du-gitrepository-k8s-kind-apps-pour-chacune-des-applications" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©finition du GitRepository "k8s-kind-apps" pour chacune des applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definition-des-kustomizations-pour-chacun-des-gitrepositories" class="md-nav__link">
    <span class="md-ellipsis">
      DÃ©finition des 'Kustomizations' pour chacun des GitRepositories
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagerepository" class="md-nav__link">
    <span class="md-ellipsis">
      ImageRepository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagepolicy" class="md-nav__link">
    <span class="md-ellipsis">
      ImagePolicy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#marquage-des-manifests-de-deploiement-de-de-foo-et-bar" class="md-nav__link">
    <span class="md-ellipsis">
      Marquage des manifests de dÃ©ploiement de de 'foo' et 'bar'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#image-update-automation" class="md-nav__link">
    <span class="md-ellipsis">
      Image Update Automation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exposition-des-applications" class="md-nav__link">
    <span class="md-ellipsis">
      Exposition des applications
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notifications-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Notifications Discord
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Notifications Discord">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation-du-client-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Installation du client 'Discord'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-dun-serveur-et-dun-channel-pour-chaque-application" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un 'serveur' et d'un 'channel' pour chaque application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CrÃ©ation d'un 'serveur' et d'un 'channel' pour chaque application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creation-dun-serveur-discord" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un serveur Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-dun-salon-dans-notre-serveur-discord" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un salon dans notre serveur Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-dun-webhook-pour-chaque-salon" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation d'un 'webhook' pour chaque salon
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enregistrement-des-webhook-des-salons-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Enregistrement des webhook des salons Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creation-des-notification-providers" class="md-nav__link">
    <span class="md-ellipsis">
      CrÃ©ation des 'notification providers'
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-des-alertes-discord" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration des alertes Discord
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activation-des-alertes-et-notifications" class="md-nav__link">
    <span class="md-ellipsis">
      Activation des alertes et notifications
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Activation des alertes et notifications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mise-en-place" class="md-nav__link">
    <span class="md-ellipsis">
      Mise en place
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests" class="md-nav__link">
    <span class="md-ellipsis">
      Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollback" class="md-nav__link">
    <span class="md-ellipsis">
      Rollback
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="fluxcd-demonstration-par-lexemple">FluxCD - DÃ©monstration par l'exemple</h1>
<hr />
<h2 id="abstract">Abstract</h2>
<p>Sur un cluster Kind fraÃ®chement installÃ©, nous installerons FluxCD (ie. <em>'bootstrap'</em>) pour gÃ©rer le dÃ©ploiement et la mise Ã  jour de 2 applications trÃ¨s simples, que nous exposerons par la suite avec le contrÃ´leur Nginx du cluster. Nous mettrons Ã©galement en place des notifications pour nous alerter via la messagerie instantanÃ©e Discord des Ã©volutions apportÃ©es Ã  nos applications.</p>
<pre class="mermaid"><code>
graph TD

A(users)
B(("ingress\n'foobar'"))
C{service\n'foo'}
D{service\n'bar'}
E[deployment\n'foo']
F[deployment\n'bar']

A -.-&gt; B
B --&gt; C &amp; D

subgraph application 'foo'
C --&gt; E
end

subgraph application 'bar'
D --&gt; F
end</code></pre>
<p>En rÃ©alitÃ©, ces deux applications sont strictement les mÃªmes, puisqu'elles consistent chacune en 1 pod faisant usage de la mÃªme image <em>'e2e-test-images/agnhost'</em>, mais nous considÃ©rerons qu'il s'agit bel et bien de 2 applications distinctes diffÃ©rentes.</p>
<hr />
<h2 id="pre-requis">PrÃ©-requis</h2>
<h3 id="preparation-de-notre-environnement-de-travail-en-local">PrÃ©paration de notre environnement de travail en local</h3>
<p>Nous avons dÃ©jÃ  suivi les howtos suivant pour prÃ©parer notre environnement de travail sur notre laptop avec les CLIs et un cluster Kins opÃ©rationnel :</p>
<table>
<thead>
<tr>
<th>howto</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command Line Tools</td>
<td><a href="https://papafrancky.github.io/000_setup/Command_line_tools/">https://papafrancky.github.io/000_setup/Command_line_tools/</a></td>
</tr>
<tr>
<td>Kubernetes en local</td>
<td><a href="https://papafrancky.github.io/000_setup/Kubernetes_en_local/">https://papafrancky.github.io/000_setup/Kubernetes_en_local/</a></td>
</tr>
</tbody>
</table>
<h3 id="creation-des-depots-github">CrÃ©ation des dÃ©pÃ´ts GitHub</h3>
<p>CommenÃ§ons par nous identifier sur GitHub et crÃ©ons deux nouveaux dÃ©pÃ´ts privÃ©s :</p>
<table>
<thead>
<tr>
<th>DÃ©pÃ´t</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-kind-fluxcd</td>
<td>dÃ©pÃ´t GitHub dÃ©diÃ© Ã  FluxCD sur notre cluster</td>
</tr>
<tr>
<td>k8s-kind-apps</td>
<td>dÃ©pÃ´t GitHub dÃ©diÃ© Ã  l'hÃ©bergement des applications Ã  dÃ©ployer via FluxCD</td>
</tr>
</tbody>
</table>
<p><img alt="Nouveau dÃ©pÃ´t GitHub dÃ©diÃ© Ã  FluxCD" src="../images/new_github_repository_dedicated_to_fluxcd.png" /></p>
<p><img alt="Nouveau dÃ©pÃ´t GitHub dÃ©diÃ© aux applications" src="../images/new_github_repository_dedicated_to_apps.png" /></p>
<h3 id="clonage-des-depots-en-local">Clonage des dÃ©pÃ´ts en local</h3>
<p>Une fois les dÃ©pÃ´ts crÃ©Ã©s, nous les clonons sur notre laptop :</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Nous clonerons tous nos dÃ©pÃ´ts dans le rÃ©pertoire renseignÃ© dans la variable <strong>${LOCAL_GITHUB_REPOS}</strong>.</p>
</div>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:papafrancky/k8s-kind-fluxcd.git
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:papafrancky/k8s-kind-apps.git
</span></code></pre></div>
<hr />
<h2 id="bootstrap-de-fluxcd">Bootstrap de FluxCD</h2>
<p>Le projet Flux est composÃ© d'un outil en ligne de commande (le FLux CLI) et d'une sÃ©rie de contrÃ´leurs Kubernetes.</p>
<p>Pour installer Flux, vous devez d'abord tÃ©lÃ©charger le CLI de Flux. Ensuite, Ã  l'aide de la CLI, vous pouvez dÃ©ployer les contrÃ´leurs Flux sur vos clusters et configurer votre premier pipeline de livraison GitOps.</p>
<p>La commande <em>'flux bootstrap github'</em> dÃ©ploie les contrÃ´leurs Flux sur un cluster Kubernetes et configure ces derniers pour synchroniser l'Ã©tat du cluster Ã  partir d'un dÃ©pÃ´t GitHub. En plus d'installer les contrÃ´leurs, la commande bootstrap pousse les manifestes de Flux vers le dÃ©pÃ´t GitHub et configure Flux pour qu'il se mette Ã  jour Ã  partir de Git.</p>
<table>
<thead>
<tr>
<th>Doc</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>Install the Flux controllers</td>
<td>https://fluxcd.io/flux/installation/#install-the-flux-controllers</td>
</tr>
<tr>
<td>Flux bootstrap for GitHub</td>
<td>https://fluxcd.io/flux/installation/bootstrap/github/</td>
</tr>
<tr>
<td>GitHub default environment variables</td>
<td>https://docs.github.com/en/actions/learn-github-actions/variables#default-environment-variables</td>
</tr>
</tbody>
</table>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">code</label><label for="__tabbed_1_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GITHUB_USER</span><span class="o">=</span>papaFrancky
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GITHUB_TOKEN</span><span class="o">=</span>&lt;my_github_personal_access_token&gt;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">FLUXCD_GITHUB_REPO</span><span class="o">=</span>k8s-kind-fluxcd
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>flux<span class="w"> </span>bootstrap<span class="w"> </span>github<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span>--token-auth<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">  </span>--owner<span class="w"> </span><span class="si">${</span><span class="nv">GITHUB_USER</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">  </span>--repository<span class="w"> </span><span class="si">${</span><span class="nv">FLUXCD_GITHUB_REPO</span><span class="si">}</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">  </span>--branch<span class="o">=</span>main<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span>--path<span class="o">=</span>.<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">  </span>--personal<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">  </span>--components-extra<span class="o">=</span>image-reflector-controller,image-automation-controller
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>âº<span class="w"> </span>connecting<span class="w"> </span>to<span class="w"> </span>github.com
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>âº<span class="w"> </span>cloning<span class="w"> </span>branch<span class="w"> </span><span class="s2">&quot;main&quot;</span><span class="w"> </span>from<span class="w"> </span>Git<span class="w"> </span>repository<span class="w"> </span><span class="s2">&quot;https://github.com/papaFrancky/k8s-kind-fluxcd.git&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>â<span class="w"> </span>cloned<span class="w"> </span>repository
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>âº<span class="w"> </span>generating<span class="w"> </span>component<span class="w"> </span>manifests
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>â<span class="w"> </span>generated<span class="w"> </span>component<span class="w"> </span>manifests
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>â<span class="w"> </span>component<span class="w"> </span>manifests<span class="w"> </span>are<span class="w"> </span>up<span class="w"> </span>to<span class="w"> </span>date
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>âº<span class="w"> </span>installing<span class="w"> </span>components<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;flux-system&quot;</span><span class="w"> </span>namespace
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>â<span class="w"> </span>installed<span class="w"> </span>components
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>â<span class="w"> </span>reconciled<span class="w"> </span>components
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>âº<span class="w"> </span>determining<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>secret<span class="w"> </span><span class="s2">&quot;flux-system/flux-system&quot;</span><span class="w"> </span>exists
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>âº<span class="w"> </span>generating<span class="w"> </span><span class="nb">source</span><span class="w"> </span>secret
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>âº<span class="w"> </span>applying<span class="w"> </span><span class="nb">source</span><span class="w"> </span>secret<span class="w"> </span><span class="s2">&quot;flux-system/flux-system&quot;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>â<span class="w"> </span>reconciled<span class="w"> </span><span class="nb">source</span><span class="w"> </span>secret
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>âº<span class="w"> </span>generating<span class="w"> </span>sync<span class="w"> </span>manifests
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>â<span class="w"> </span>generated<span class="w"> </span>sync<span class="w"> </span>manifests
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>â<span class="w"> </span>sync<span class="w"> </span>manifests<span class="w"> </span>are<span class="w"> </span>up<span class="w"> </span>to<span class="w"> </span>date
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>âº<span class="w"> </span>applying<span class="w"> </span>sync<span class="w"> </span>manifests
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>â<span class="w"> </span>reconciled<span class="w"> </span>sync<span class="w"> </span>configuration
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>â<span class="w"> </span>waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>Kustomization<span class="w"> </span><span class="s2">&quot;flux-system/flux-system&quot;</span><span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>reconciled
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>â<span class="w"> </span>Kustomization<span class="w"> </span>reconciled<span class="w"> </span>successfully
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>âº<span class="w"> </span>confirming<span class="w"> </span>components<span class="w"> </span>are<span class="w"> </span>healthy
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>â<span class="w"> </span>helm-controller:<span class="w"> </span>deployment<span class="w"> </span>ready
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>â<span class="w"> </span>image-automation-controller:<span class="w"> </span>deployment<span class="w"> </span>ready
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>â<span class="w"> </span>image-reflector-controller:<span class="w"> </span>deployment<span class="w"> </span>ready
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>â<span class="w"> </span>kustomize-controller:<span class="w"> </span>deployment<span class="w"> </span>ready
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>â<span class="w"> </span>notification-controller:<span class="w"> </span>deployment<span class="w"> </span>ready
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>â<span class="w"> </span>source-controller:<span class="w"> </span>deployment<span class="w"> </span>ready
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>â<span class="w"> </span>all<span class="w"> </span>components<span class="w"> </span>are<span class="w"> </span>healthy
</span></code></pre></div>
</div>
</div>
</div>
<p>VÃ©rifions dans les Ã©vÃ©nements de FluxCD :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">code</label><label for="__tabbed_2_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>flux<span class="w"> </span>events
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>LAST<span class="w"> </span>SEEN<span class="w">          </span>TYPE<span class="w">    </span>REASON<span class="w">                  </span>OBJECT<span class="w">                          </span>MESSAGE
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>15m<span class="w">                     </span>Normal<span class="w">  </span>NewArtifact<span class="w">             </span>GitRepository/flux-system<span class="w">       </span>stored<span class="w"> </span>artifact<span class="w"> </span><span class="k">for</span><span class="w"> </span>commit<span class="w"> </span><span class="s1">&#39;Add Flux sync manifests&#39;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>15m<span class="w">                     </span>Normal<span class="w">  </span>ReconciliationSucceeded<span class="w"> </span>Kustomization/flux-system<span class="w">       </span>Reconciliation<span class="w"> </span>finished<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">2</span>.536346081s,<span class="w"> </span>next<span class="w"> </span>run<span class="w"> </span><span class="k">in</span><span class="w"> </span>10m0s
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>15m<span class="w">                     </span>Normal<span class="w">  </span>Progressing<span class="w">             </span>Kustomization/flux-system<span class="w">       </span>CustomResourceDefinition/alerts.notification.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">                                                                                        </span>CustomResourceDefinition/buckets.source.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">                                                                                        </span>CustomResourceDefinition/gitrepositories.source.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">                                                                                        </span>CustomResourceDefinition/helmcharts.source.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">                                                                                        </span>CustomResourceDefinition/helmreleases.helm.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">                                                                                        </span>CustomResourceDefinition/helmrepositories.source.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">                                                                                        </span>CustomResourceDefinition/imagepolicies.image.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">                                                                                        </span>CustomResourceDefinition/imagerepositories.image.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">                                                                                        </span>CustomResourceDefinition/imageupdateautomations.image.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">                                                                                        </span>CustomResourceDefinition/kustomizations.kustomize.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">                                                                                        </span>CustomResourceDefinition/ocirepositories.source.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">                                                                                        </span>CustomResourceDefinition/providers.notification.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">                                                                                        </span>CustomResourceDefinition/receivers.notification.toolkit.fluxcd.io<span class="w"> </span>configured
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">                                                                                        </span>Namespace/flux-system<span class="w"> </span>configured
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">                                                                                        </span>ServiceAccount/flux-system/helm-controller<span class="w"> </span>configured
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">                                                                                        </span>ServiceAccount/flux-system/image-automation-controller<span class="w"> </span>configured
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">                                                                                        </span>ServiceAccount/flux-system/image-reflector-controller<span class="w"> </span>configured
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">                                                                                        </span>ServiceAccount/flux-system/kustomize-controller<span class="w"> </span>configured
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">                                                                                        </span>ServiceAccount/flux-system/notification-controller<span class="w"> </span>configured
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">                                                                                        </span>ServiceAccount/flux-system/source-controller<span class="w"> </span>configured
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">                                                                                        </span>ClusterRole/crd-controller-flux-system<span class="w"> </span>configured
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">                                                                                        </span>ClusterRole/flux-edit-flux-system<span class="w"> </span>configured
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">                                                                                        </span>ClusterRole/flux-view-flux-system<span class="w"> </span>configured
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">                                                                                        </span>ClusterRoleBinding/cluster-reconciler-flux-system<span class="w"> </span>configured
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="w">                                                                                        </span>ClusterRoleBinding/crd-controller-flux-system<span class="w"> </span>configured
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">                                                                                        </span>Service/flux-system/notification-controller<span class="w"> </span>configured
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">                                                                                        </span>Service/flux-system/source-controller<span class="w"> </span>configured
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="w">                                                                                        </span>Service/flux-system/webhook-receiver<span class="w"> </span>configured
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="w">                                                                                        </span>Deployment/flux-system/helm-controller<span class="w"> </span>configured
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="w">                                                                                        </span>Deployment/flux-system/image-automation-controller<span class="w"> </span>configured
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="w">                                                                                        </span>Deployment/flux-system/image-reflector-controller<span class="w"> </span>configured
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="w">                                                                                        </span>Deployment/flux-system/kustomize-controller<span class="w"> </span>configured
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="w">                                                                                        </span>Deployment/flux-system/notification-controller<span class="w"> </span>configured
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="w">                                                                                        </span>Deployment/flux-system/source-controller<span class="w"> </span>configured
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="w">                                                                                        </span>Kustomization/flux-system/flux-system<span class="w"> </span>configured
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="w">                                                                                        </span>NetworkPolicy/flux-system/allow-egress<span class="w"> </span>configured
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="w">                                                                                        </span>NetworkPolicy/flux-system/allow-scraping<span class="w"> </span>configured
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="w">                                                                                        </span>NetworkPolicy/flux-system/allow-webhooks<span class="w"> </span>configured
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="w">                                                                                        </span>GitRepository/flux-system/flux-system<span class="w"> </span>configured
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>5m29s<span class="w">                   </span>Normal<span class="w">  </span>ReconciliationSucceeded<span class="w"> </span>Kustomization/flux-system<span class="w">       </span>Reconciliation<span class="w"> </span>finished<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">761</span>.801712ms,<span class="w"> </span>next<span class="w"> </span>run<span class="w"> </span><span class="k">in</span><span class="w"> </span>10m0s
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>22s<span class="w"> </span><span class="o">(</span>x15<span class="w"> </span>over<span class="w"> </span>14m<span class="o">)</span><span class="w">      </span>Normal<span class="w">  </span>GitOperationSucceeded<span class="w">   </span>GitRepository/flux-system<span class="w">       </span>no<span class="w"> </span>changes<span class="w"> </span>since<span class="w"> </span>last<span class="w"> </span>reconcilation:<span class="w"> </span>observed<span class="w"> </span>revision<span class="w"> </span><span class="s1">&#39;main@sha1:1258fc09abf6cd1bd639cd18ce4a2e9e4c1a7a9b&#39;</span>
</span></code></pre></div>
</div>
</div>
</div>
<p>Cherchons les objets crÃ©Ã©s dans le namespace de FluxCD :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">code</label><label for="__tabbed_3_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>flux-system<span class="w"> </span>get<span class="w"> </span>all
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>NAME<span class="w">                                               </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>pod/helm-controller-57694fc9d6-pbl5c<span class="w">               </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>19m
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>pod/image-automation-controller-5f7d999559-49fms<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>19m
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>pod/image-reflector-controller-58db7c9785-mjfh5<span class="w">    </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>19m
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>pod/kustomize-controller-7f689848b9-k7hmd<span class="w">          </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>19m
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>pod/notification-controller-6cffcffd7d-rkmwl<span class="w">       </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>19m
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>pod/source-controller-7f95c446b6-b8gcd<span class="w">             </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>19m
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>NAME<span class="w">                              </span>TYPE<span class="w">        </span>CLUSTER-IP<span class="w">     </span>EXTERNAL-IP<span class="w">   </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">   </span>AGE
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>service/notification-controller<span class="w">   </span>ClusterIP<span class="w">   </span><span class="m">10</span>.96.206.29<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">80</span>/TCP<span class="w">    </span>19m
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>service/source-controller<span class="w">         </span>ClusterIP<span class="w">   </span><span class="m">10</span>.96.94.126<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">80</span>/TCP<span class="w">    </span>19m
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>service/webhook-receiver<span class="w">          </span>ClusterIP<span class="w">   </span><span class="m">10</span>.96.125.18<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">80</span>/TCP<span class="w">    </span>19m
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>NAME<span class="w">                                          </span>READY<span class="w">   </span>UP-TO-DATE<span class="w">   </span>AVAILABLE<span class="w">   </span>AGE
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>deployment.apps/helm-controller<span class="w">               </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>19m
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>deployment.apps/image-automation-controller<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>19m
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>deployment.apps/image-reflector-controller<span class="w">    </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>19m
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>deployment.apps/kustomize-controller<span class="w">          </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>19m
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>deployment.apps/notification-controller<span class="w">       </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>19m
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>deployment.apps/source-controller<span class="w">             </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>19m
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>NAME<span class="w">                                                     </span>DESIRED<span class="w">   </span>CURRENT<span class="w">   </span>READY<span class="w">   </span>AGE
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>replicaset.apps/helm-controller-57694fc9d6<span class="w">               </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">       </span>19m
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>replicaset.apps/image-automation-controller-5f7d999559<span class="w">   </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">       </span>19m
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>replicaset.apps/image-reflector-controller-58db7c9785<span class="w">    </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">       </span>19m
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>replicaset.apps/kustomize-controller-7f689848b9<span class="w">          </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">       </span>19m
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>replicaset.apps/notification-controller-6cffcffd7d<span class="w">       </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">       </span>19m
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>replicaset.apps/source-controller-7f95c446b6<span class="w">             </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">         </span><span class="m">1</span><span class="w">       </span>19m
</span></code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="gestion-automatique-des-deploiements-dapplications-par-fluxcd">Gestion automatique des dÃ©ploiements d'applications par FluxCD</h2>
<p>FluxCD peut gÃ©rer l'automatisation du dÃ©ploiement d'applications packagÃ©es avec Helm ou bien directement depuis un dÃ©pÃ´t Git. Nous allons d'abord nous concentrer sur le dÃ©ploiement d'applications depuis un dÃ©pÃ´t Git (GitHub dans notre cas).</p>
<p>Les objets de FluxCD sont un peu comme des poupÃ©es Russes, il est important de garder en tÃªte leurs interdÃ©pendances pour comprendre l'ordre dans lequel nous devrons les crÃ©er.</p>
<pre class="mermaid"><code>graph RL

ImagePolicy("Image\nPolicy")
ImageRepository("Image\nRepository")
ImageRegistry("Docker\nimage\nregistry")
Deployment("Deployment")
ImageUpdateAutomation("Image\nUpdate\nAutomation")
GithubRepository("GitHub\nRepository")
Kustomization("Kustomization")
GitRepository("Git\nRepository")
DeployKeys("(secret)\ndeploy\nkeys")
HelmRelease("Helm\nRelease")
HelmRepository("Helm\nRepository")
HelmRegistry("Helm\nRegistry")
Alert("Alert")
Provider("Provider")
InstantMessaging("Discord\nInstant\nMessaging")
Webhook("(secret)\nDiscord\nWebhook")

classDef FluxCDObject fill:olivedrab,stroke:darkolivegreen,stroke-width:3px;
class ImagePolicy,ImageRepository,ImageUpdateAutomation,Kustomization,GitRepository,HelmRelease,HelmRepository,Alert,Provider FluxCDObject

ImageRegistry ----&gt; ImageRepository
ImageRegistry --&gt; Deployment
ImageRepository --&gt; ImagePolicy
Deployment --&gt; GithubRepository
GithubRepository --&gt; ImageUpdateAutomation &amp; GitRepository
DeployKeys --&gt; GitRepository
GitRepository --&gt; Kustomization

HelmRepository --&gt; HelmRelease
HelmRegistry ----&gt; HelmRepository

InstantMessaging &amp; Webhook ----&gt; Provider
Provider --&gt; Alert</code></pre>
<h3 id="namespaces-dedies-a-lapplication">Namespaces dÃ©diÃ©s Ã  l'application</h3>
<p>Chaque application sera hÃ©bergÃ©e dans son propre namespace.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><input id="__tabbed_4_3" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">code</label><label for="__tabbed_4_2">foo namespace</label><label for="__tabbed_4_3">bar namespace</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>mkdir<span class="w"> </span>foo<span class="w"> </span>bar
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>foo<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>foo/namespace.yaml
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>bar<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>bar/namespace.yaml
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>foo/namespace.yaml
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>bar/namespace.yml
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;created namespace &#39;k8s-kind-apps&#39;.&quot;</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>git<span class="w"> </span>push
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>apiVersion:<span class="w"> </span>v1
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>kind:<span class="w"> </span>Namespace
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>metadata:
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span>name:<span class="w"> </span>foo
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>apiVersion:<span class="w"> </span>v1
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>kind:<span class="w"> </span>Namespace
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>metadata:
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span>name:<span class="w"> </span>bar
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="depot-github-dedie-aux-applications">DÃ©pÃ´t GitHub dÃ©diÃ© aux applications</h3>
<p>Les applications seront rÃ©cupÃ©rÃ©es directement depuis un dÃ©pÃ´t Git. Si elles avaient Ã©tÃ© packagÃ©es sous la forme d'une Helm Chart, FluxCD les aurait rÃ©cupÃ©rÃ© directement depuis un dÃ©pÃ´t Helm.</p>
<p>Nous avons prÃ©alablement crÃ©Ã© sur GitHub un dÃ©pÃ´t dÃ©diÃ© Ã  l'hÃ©bergement de toutes les applications que FluxCD va gÃ©rer pour notre cluster : github.com/${GITHUB_USERNAME}/<strong>k8s-kind-apps</strong>.</p>
<p>Nous allons crÃ©er dans la copie locale (git clone) de ce dÃ©pÃ´t sur notre poste de travail un sous-rÃ©pertoire qui contiendra son application : </p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-apps
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>mkdir<span class="w"> </span>foo<span class="w"> </span>bar
</span></code></pre></div>
<p>Les applications 'foo' et 'bar' sont trÃ¨s simples, et sont composÃ©es d'un pod et d'un service en frontal :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:4"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><input id="__tabbed_5_4" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">deployment: foo</label><label for="__tabbed_5_2">service: foo</label><label for="__tabbed_5_3">deployment: bar</label><label for="__tabbed_5_4">service: bar</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; foo/deployment.yaml</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="s">apiVersion: apps/v1</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="s">kind: Deployment</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="s">metadata:</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="s">  labels:</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="s">    app: foo</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="s">  name: foo</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="s">spec:</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="s">  replicas: 1</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="s">  selector:</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="s">    matchLabels:</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="s">      app: foo</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="s">  template:</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="s">    metadata:</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="s">      labels:</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="s">        app: foo</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="s">    spec:</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="s">      containers:</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="s">      - name: agnhost</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="s">        image: registry.k8s.io/e2e-test-images/agnhost:2.39</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="s">        command:</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="s">        - /agnhost</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="s">        - netexec</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="s">        - --http-port</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="s">        - &quot;8080&quot;</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="s">EOF</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; foo/service.yaml</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="s">---</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="s">kind: Service</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="s">apiVersion: v1</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="s">metadata:</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="s">  name: foo</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="s">spec:</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="s">  selector:</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="s">    app: foo</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="s">  ports:</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="s">  # Default port used by the image</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="s">  - port: 8080</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="s">    EOF</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; bar/deployment.yaml</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="s">apiVersion: apps/v1</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="s">kind: Deployment</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="s">metadata:</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="s">  labels:</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="s">    app: bar</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="s">  name: bar</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="s">spec:</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="s">  replicas: 1</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="s">  selector:</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="s">    matchLabels:</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="s">      app: bar</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="s">  template:</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="s">    metadata:</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="s">      labels:</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="s">        app: bar</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="s">    spec:</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="s">      containers:</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="s">      - name: agnhost</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="s">        image: registry.k8s.io/e2e-test-images/agnhost:2.39</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="s">        command:</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="s">        - /agnhost</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="s">        - netexec</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="s">        - --http-port</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="s">        - &quot;8080&quot;</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="s">EOF</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; bar/service.yaml</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="s"> ---</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="s">kind: Service</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="s">apiVersion: v1</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="s">metadata:</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="s">  name: bar</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="s">spec:</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="s">  selector:</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="s">    app: bar</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="s">  ports:</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="s">  # Default port used by the image</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="s">  - port: 8080</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="s">    EOF</span>
</span></code></pre></div>
</div>
</div>
</div>
<p>Nous avons dÃ©crit nos applications sous la forme de manifests YAML sur notre copie locale du dÃ©pÃ´t dÃ©diÃ© aux applications :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">code</label><label for="__tabbed_6_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>tree<span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-apps
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-apps
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>âââ<span class="w"> </span>bar
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>â<span class="w">Â Â  </span>âââ<span class="w"> </span>deployment.yaml
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>â<span class="w">Â Â  </span>âââ<span class="w"> </span>namespace.yaml
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>â<span class="w">Â Â  </span>âââ<span class="w"> </span>service.yaml
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>âââ<span class="w"> </span>foo
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span>âââ<span class="w"> </span>deployment.yaml
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span>âââ<span class="w"> </span>namespace.yaml
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span>âââ<span class="w"> </span>service.yaml
</span></code></pre></div>
</div>
</div>
</div>
<p>Il ne nous reste plus qu'Ã  pousser les modifications sur notre dÃ©pÃ´t GitHub :</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-apps
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;feat: added foobar app.&#39;</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>git<span class="w"> </span>push
</span></code></pre></div>
<p>Les applications se trouvent dÃ©sormais bien dans le dÃ©pÃ´t GitHub dÃ©diÃ© aux applications :</p>
<p><img alt="foobar application is uploaded in the Github repository dedicated to apps" src="../images/foo_bar_apps_in_github_repo.png" /></p>
<p>Nous allons pouvoir dÃ©finir ces dÃ©pÃ´ts au niveau de FluxCd pour que ce dernier puisse les gÃ©rer.</p>
<hr />
<h3 id="definition-des-gitrepository-de-chacune-de-nos-applications">DÃ©finition des GitRepository de chacune de nos applications</h3>
<p>Nous allons dÃ©finir au niveau de FluxCD le dÃ©pÃ´t GitHub de chacune des applications et lui permettre de s'y connecter avec les droits d'Ã©criture. Dans notre cas, nous utilisons un mÃªme dÃ©pÃ´t GitHub pour toutes nos applications. Nous pourrions nous contenter de ne dÃ©finir qu'un seul GitRepository mais avons fait le choix de rÃ©duire tant que possible des adhÃ©ences Ã©ventuelles entre applications. En dÃ©finissant un GitRepository par application, nous permettons ainsi la suppression de tous les objets Kubernetes liÃ©es Ã  une application sans dÃ©pendances avec les autres objets des applications restantes. Il n'y a pas de bon ou de mauvais choix, c'est simplement le nÃ´tre.</p>
<h4 id="deploy-keys">Deploy Keys</h4>
<p>Pour permettre Ã  FluxCD de se connecter aux dÃ©pÃ´ts GitHub des applications qu'il doit gÃ©rer, nous devons crÃ©er une paire de clÃ©s SSH et dÃ©ployer la clÃ© publique sur les dÃ©pÃ´ts concernÃ©s.</p>
<h4 id="creation-des-deploy-keys">CrÃ©ation des <em>'Deploy Keys'</em></h4>
<p>Nous devons crÃ©er une paire de clÃ©s SSH pour permettre Ã  FluxCD de se connecter avec les droits d'Ã©criture au dÃ©pÃ´t dÃ©diÃ© Ã  FluxCD. Nous en aurons besoin pour dÃ©finir le <em>'GitRepository'</em>.
S'agissant de 'secrets', nous ne conserverons pas le manifest YAML dans le dÃ©pÃ´t.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GITHUB_USERNAME</span><span class="o">=</span>papafrancky
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>flux<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>git<span class="w"> </span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span>--url<span class="o">=</span>ssh://github.com/<span class="si">${</span><span class="nv">GITHUB_USERNAME</span><span class="si">}</span>/k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span>--namespace<span class="o">=</span>foo
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>flux<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>git<span class="w"> </span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">  </span>--url<span class="o">=</span>ssh://github.com/<span class="si">${</span><span class="nv">GITHUB_USERNAME</span><span class="si">}</span>/k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">  </span>--namespace<span class="o">=</span>bar
</span></code></pre></div>
<p>VÃ©rifions la bonne crÃ©ation du secret :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:3"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><input id="__tabbed_7_3" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">code</label><label for="__tabbed_7_2">foo secret</label><label for="__tabbed_7_3">bar secret</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>k8s-kind-apps<span class="w"> </span>-o<span class="w"> </span>yaml
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>bar<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>k8s-kind-apps<span class="w"> </span>-o<span class="w"> </span>yaml
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>apiVersion:<span class="w"> </span>v1
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>data:
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">  </span>identity:<span class="w">     </span>LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JRzJBZ0VBTUJBR0J5cUdTTTQ5QWdFR0JTdUJCQUFpQklHZU1JR2JBZ0VCQkRCWk1HVXAwNTJLT1BmbE85UU4KTlZBbzBzY3Y1bzlMTElUVzFieUorZTFaVlRNQWl1cXd0YkhHdDc3TlVzUUZ0T2FoWkFOaUFBU0JyWXhNOUxUcwp0Wmp1d2hkL0J5bVI3Sks4cy9zQk5zSEkwdGprMFQyRGg<span class="w">    </span>1dlFOTkNaK1lEb2pEb0FBZk82bWN3NytOalV3cGd1CnlOTTNGb081Q3piSTJ0aEwzdHNmMjV2aWZ3blpobERNZDRiSGdCMUNKekJrWHBROUlRTnBQNmM9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span>identity.pub:<span class="w">     </span>ZWNkc2Etc2hhMi1uaXN0cDM4NCBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF6T0RRQUFBQUlibWx6ZEhBek9EUUFBQUJoQklHdGpFejB0T3kxbU83Q0YzOEhLWkhza3J5eit3RTJ3Y2pTMk9UUlBZT0htOUEwMEpuNWdPaU1PZ0FCODdxWnpEdjQyTlRDbUM3STB6Y1dnN2tMTnNqYTJFdmUyeC9ibStKL0NkbUdVTXgzaHNlQUhVSW5NR1J<span class="w">    </span><span class="nv">lbEQwaEEyay9wdz09Cg</span><span class="o">==</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">  </span>known_hosts:<span class="w"> </span>Z2l0aHViLmNvbSBlY2RzYS1zaGEyLW5pc3RwMjU2IEFBQUFFMlZqWkhOaExYTm9ZVEl0Ym1semRIQXlOVFlBQUFBSWJtbHpkSEF5TlRZQUFBQkJCRW1LU0VOalFFZXpPbXhrWk15N29wS2d3RkI5bmt0NVlScllNak51RzVOODd1UmdnNkNMcmJvNXdBZFQveTZ2MG1LVjBVMncwV1oyWUIvKytUcG9ja2c9
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>kind:<span class="w"> </span>Secret
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>metadata:
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">  </span>creationTimestamp:<span class="w"> </span><span class="s2">&quot;2024-04-27T08:49:36Z&quot;</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">  </span>resourceVersion:<span class="w"> </span><span class="s2">&quot;1295276&quot;</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">  </span>uid:<span class="w"> </span>a319b96b-80a0-457a-aa33-0fc23ab7def6
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>type:<span class="w"> </span>Opaque
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>apiVersion:<span class="w"> </span>v1
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>data:
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span>identity:<span class="w">     </span>LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JRzJBZ0VBTUJBR0J5cUdTTTQ5QWdFR0JTdUJCQUFpQklHZU1JR2JBZ0VCQkRDcVRkUlpaK1BuWjRYYWRCelMKb2hoQjdjMVBVNEh5OVYzeXp6dTFJdU9HMlFVd09vMUtBN0I3M0dweGJaUUI2K2VoWkFOaUFBUnA5UmFwaFMzTgpPaVRsTzZ2TEdQSG0va2NHR2YzYzk0eHpRR041Q0ltV1V<span class="w">    </span>WS0xlQi9NajdGK1d0RzEyVmZ3QVRGaTFoclhkVUg4CkxWQ29JUjJoeUp3Y251R2dZaEYrc3pTanBuSDA1dVpuVm5ibXhUZmlleWkxNUNibGpOOGVrQnM9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span>identity.pub:<span class="w">     </span>ZWNkc2Etc2hhMi1uaXN0cDM4NCBBQUFBRTJWalpITmhMWE5vWVRJdGJtbHpkSEF6T0RRQUFBQUlibWx6ZEhBek9EUUFBQUJoQkduMUZxbUZMYzA2Sk9VN3E4c1k4ZWIrUndZWi9kejNqSE5BWTNrSWlaWlJVb3Q0SDh5UHNYNWEwYlhaVi9BQk1XTFdHdGQxUWZ3dFVLZ2hIYUhJbkJ5ZTRhQmlFWDZ6TktPbWNmVG01bWRXZHViRk4rSjdLTFh<span class="w">    </span><span class="nv">rSnVXTTN4NlFHdz09Cg</span><span class="o">==</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">  </span>known_hosts:<span class="w"> </span>Z2l0aHViLmNvbSBlY2RzYS1zaGEyLW5pc3RwMjU2IEFBQUFFMlZqWkhOaExYTm9ZVEl0Ym1semRIQXlOVFlBQUFBSWJtbHpkSEF5TlRZQUFBQkJCRW1LU0VOalFFZXpPbXhrWk15N29wS2d3RkI5bmt0NVlScllNak51RzVOODd1UmdnNkNMcmJvNXdBZFQveTZ2MG1LVjBVMncwV1oyWUIvKytUcG9ja2c9
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>kind:<span class="w"> </span>Secret
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>metadata:
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">  </span>creationTimestamp:<span class="w"> </span><span class="s2">&quot;2024-04-27T08:50:31Z&quot;</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">  </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">  </span>resourceVersion:<span class="w"> </span><span class="s2">&quot;1295422&quot;</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">  </span>uid:<span class="w"> </span>eaab7311-c1f1-4579-8157-0a2d131f9e2b
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>type:<span class="w"> </span>Opaque
</span></code></pre></div>
</div>
</div>
</div>
<h4 id="ajout-de-la-cle-publique-sur-le-depot-github">Ajout de la clÃ© publique sur le dÃ©pÃ´t GitHub</h4>
<p>Les clÃ©s publiques doivent Ãªtre extraites des 'secrets' et renseignÃ©es dans les paramÃ¨tres du dÃ©pÃ´t GitHub  <em><em>k8s-kind-fluxcd</em></em>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:3"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><input id="__tabbed_8_3" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">code</label><label for="__tabbed_8_2">foo public key</label><label for="__tabbed_8_3">bar public key</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>k8s-kind-apps<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.identity\.pub}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>bar<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>k8s-kind-apps<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.identity\.pub}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d
</span></code></pre></div>
</div>
<div class="tabbed-block">
<p>'''sh
ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzODQAAABhBIGtjEz0tOy1mO7CF38HKZHskryz+wE2wcjS2OTRPYOHm9A00Jn5gOiMOgAB87qZzDv42NTCmC7I0zcWg7kLNsja2Eve2x/bm+J/CdmGUMx3hseAHUInMGRelD0hA2k/pw==
'''</p>
</div>
<div class="tabbed-block">
<p>'''sh
ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzODQAAABhBGn1FqmFLc06JOU7q8sY8eb+RwYZ/dz3jHNAY3kIiZZRUot4H8yPsX5a0bXZV/ABMWLWGtd1QfwtUKghHaHInBye4aBiEX6zNKOmcfTm5mdWdubFN+J7KLXkJuWM3x6QGw==
'''</p>
</div>
</div>
</div>
<p>Une fois sur la page de dÃ©pÃ´t, cliquer sur le bouton <em><em>Settings</em></em>, puis dans la colonne de gauche sur la page suivante, sur le line <em><em>Deploy Keys</em></em> dans la partie 'Security' :</p>
<p><img alt="AccÃ©der aux settings sur le dÃ©pÃ´t GitHub" src="../images/github_settings.png" /></p>
<p><img alt="AccÃ©der aux Deploy Keys sur le dÃ©pÃ´t GitHub" src="../images/github_deploykeys.png" /></p>
<p><img alt="Ajouter une nouvelle Deploy Key" src="../images/github_add_deploykey.png" /></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>La case <strong>'Allow write access'</strong> doit Ãªtre cochÃ©e pour permettre Ã  FluxCD d'apporter des modifications dans son dÃ©pÃ´t !</p>
</div>
<p><img alt="DÃ©clarer la Deploy Key 'foo'" src="../images/github_add_foo_public_key.png" /></p>
<p><img alt="DÃ©clarer la Deploy Key 'bar'" src="../images/github_add_bar_public_key.png" /></p>
<p><img alt="Liste des 'Deploy Keys'" src="../images/github_deploy_keys_list.png" /></p>
<h4 id="definition-du-gitrepository-k8s-kind-apps-pour-chacune-des-applications">DÃ©finition du GitRepository <em>"k8s-kind-apps"</em> pour chacune des applications</h4>
<p>L'API GitRepository dÃ©finit une source pour produire un artefact pour une rÃ©vision d'un dÃ©pÃ´t Git.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>https://fluxcd.io/flux/components/source/gitrepositories/</p>
</div>
<p>Voici les informations qu'il faudra donner pour dÃ©finir un 'GitRepository' :</p>
<ul>
<li>Le nom que nous souhaitons lui donner : <em>k8s-kind-fluxcd</em>;</li>
<li>L'URL du dÃ©pÃ´t GitHub : <em>ssh://git@github.com/${GITHUB_USERNAME}/k8s-kind-fluxcd.git</em>;</li>
<li>La branche du dÃ©pÃ´t d'oÃ¹ rÃ©cupÃ©rer le code : <em>main</em>;</li>
<li>Le secret d'oÃ¹ extraire la clÃ© privÃ©e pour se connecter au dÃ©pÃ´t GitHub : <em>foo</em> ou <em>bar</em> selon l'application concernÃ©e.</li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="w">   </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">   </span><span class="nb">export</span><span class="w"> </span><span class="nv">GITHUB_USERNAME</span><span class="o">=</span>papafrancky
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">   </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">   </span>mkdir<span class="w"> </span>-p<span class="w"> </span>apps/foo<span class="w"> </span>apps/bar
</span></code></pre></div>
<div class="tabbed-set tabbed-alternate" data-tabs="9:3"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><input id="__tabbed_9_3" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">code</label><label for="__tabbed_9_2">'foo' GitRepository</label><label for="__tabbed_9_3">'bar' GitRepository</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>flux<span class="w"> </span>create<span class="w"> </span><span class="nb">source</span><span class="w"> </span>git<span class="w"> </span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span>--url<span class="o">=</span>ssh://git@github.com/<span class="si">${</span><span class="nv">GITHUB_USERNAME</span><span class="si">}</span>/k8s-kind-apps.git<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">  </span>--branch<span class="o">=</span>main<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span>--secret-ref<span class="o">=</span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">  </span>--namespace<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/foo/gitrepository.yaml
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>flux<span class="w"> </span>create<span class="w"> </span><span class="nb">source</span><span class="w"> </span>git<span class="w"> </span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">  </span>--url<span class="o">=</span>ssh://git@github.com/<span class="si">${</span><span class="nv">GITHUB_USERNAME</span><span class="si">}</span>/k8s-kind-apps.git<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">  </span>--branch<span class="o">=</span>main<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">  </span>--secret-ref<span class="o">=</span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">  </span>--namespace<span class="o">=</span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/bar/gitrepository.yaml
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>---
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>apiVersion:<span class="w"> </span>source.toolkit.fluxcd.io/v1beta2
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>kind:<span class="w"> </span>GitRepository
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>metadata:
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">  </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>spec:
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">  </span>interval:<span class="w"> </span>1m0s
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">  </span>ref:
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span>branch:<span class="w"> </span>main
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">  </span>secretRef:
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">    </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">  </span>url:<span class="w"> </span>ssh://git@github.com/papafrancky/k8s-kind-apps.git
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>---
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>apiVersion: source.toolkit.fluxcd.io/v1beta2
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>kind: GitRepository
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>metadata:
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>  name: k8s-kind-apps
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>  namespace: bar
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>spec:
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>  interval: 1m0s
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>  ref:
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>    branch: main
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>  secretRef:
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>    name: k8s-kind-apps
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>  url: ssh://git@github.com/papafrancky/k8s-kind-apps.git
</span></code></pre></div>
</div>
</div>
</div>
<h4 id="definition-des-kustomizations-pour-chacun-des-gitrepositories">DÃ©finition des <em>'Kustomizations'</em> pour chacun des GitRepositories</h4>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Nommer le manifest 'kustomize.yml' pose des problÃ¨mes, le nom doit Ãªtre rÃ©servÃ© pour les besoins internes de Flux. Nous le nommerons 'sync.yaml'.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="10:3"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><input id="__tabbed_10_3" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">code</label><label for="__tabbed_10_2">'foo' kustomization</label><label for="__tabbed_10_3">'bar' kustomization</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>flux<span class="w"> </span>create<span class="w"> </span>kustomization<span class="w"> </span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span>--source<span class="o">=</span>GitRepository/k8s-kind-apps.foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span>--path<span class="o">=</span><span class="s2">&quot;./foo&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span>--prune<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">    </span>--namespace<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/foo/sync.yaml
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>flux<span class="w"> </span>create<span class="w"> </span>kustomization<span class="w"> </span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">    </span>--source<span class="o">=</span>GitRepository/k8s-kind-apps.bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">    </span>--path<span class="o">=</span><span class="s2">&quot;./bar&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">    </span>--prune<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">    </span>--namespace<span class="o">=</span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/bar/sync.yaml
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>---
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>apiVersion:<span class="w"> </span>kustomize.toolkit.fluxcd.io/v1beta2
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>kind:<span class="w"> </span>Kustomization
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>metadata:
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">  </span>name:<span class="w"> </span>foo
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>spec:
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">  </span>interval:<span class="w"> </span>1m0s
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">  </span>path:<span class="w"> </span>./foo
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">  </span>prune:<span class="w"> </span><span class="nb">true</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">  </span>sourceRef:
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">    </span>kind:<span class="w"> </span>GitRepository
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">    </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">    </span>namespace:<span class="w"> </span>foo
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>---
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>apiVersion:<span class="w"> </span>kustomize.toolkit.fluxcd.io/v1beta2
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>kind:<span class="w"> </span>Kustomization
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>metadata:
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">  </span>name:<span class="w"> </span>bar
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>spec:
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">  </span>interval:<span class="w"> </span>1m0s
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="w">  </span>path:<span class="w"> </span>./bar
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">  </span>prune:<span class="w"> </span><span class="nb">true</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="w">  </span>sourceRef:
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="w">    </span>kind:<span class="w"> </span>GitRepository
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="w">    </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="w">    </span>namespace:<span class="w"> </span>bar
</span></code></pre></div>
</div>
</div>
</div>
<p>Il est temps de pousser nos modifications dans le dÃ©pÃ´t GitHub :</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="w">   </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">   </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">   </span>git<span class="w"> </span>status
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">   </span>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">   </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: added GitRepositories and Kustomizations for &#39;foo&#39; and &#39;bar&#39; apps.&quot;</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">   </span>git<span class="w"> </span>push
</span></code></pre></div>
<p>ForÃ§ons la rÃ©conciliation :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:2"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><input id="__tabbed_11_2" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">code</label><label for="__tabbed_11_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>flux<span class="w"> </span>reconcile<span class="w"> </span>kustomization<span class="w"> </span>flux-system<span class="w"> </span>--with-source
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>âº<span class="w"> </span>annotating<span class="w"> </span>GitRepository<span class="w"> </span>flux-system<span class="w"> </span><span class="k">in</span><span class="w"> </span>flux-system<span class="w"> </span>namespace
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>â<span class="w"> </span>GitRepository<span class="w"> </span>annotated
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>â<span class="w"> </span>waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>GitRepository<span class="w"> </span>reconciliation
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>â<span class="w"> </span>fetched<span class="w"> </span>revision<span class="w"> </span>main@sha1:f9875e137abb0d4f810b4042fa98713adaca2701
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>âº<span class="w"> </span>annotating<span class="w"> </span>Kustomization<span class="w"> </span>flux-system<span class="w"> </span><span class="k">in</span><span class="w"> </span>flux-system<span class="w"> </span>namespace
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>â<span class="w"> </span>Kustomization<span class="w"> </span>annotated
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>â<span class="w"> </span>waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>Kustomization<span class="w"> </span>reconciliation
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>â<span class="w"> </span>applied<span class="w"> </span>revision<span class="w"> </span>main@sha1:f9875e137abb0d4f810b4042fa98713adaca2701
</span></code></pre></div>
</div>
</div>
</div>
<p>Nous devrions dÃ©sormais voir le GitRepository dÃ©fini au niveau du cluster :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:2"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><input id="__tabbed_12_2" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="__tabbed_12_1">code</label><label for="__tabbed_12_2">output </label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>k -n foo get gitrepository k8s-kind-apps
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>k -n bar get gitrepository k8s-kind-apps
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>NAME            URL                                                  AGE     READY   STATUS
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>k8s-kind-apps   ssh://git@github.com/papafrancky/k8s-kind-apps.git   2m11s   True    stored artifact for revision &#39;main@sha1:cfe1c35724883dce2eaf428f144faeb3da27873b&#39;
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>NAME            URL                                                  AGE     READY   STATUS
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>k8s-kind-apps   ssh://git@github.com/papafrancky/k8s-kind-apps.git   2m28s   True    stored artifact for revision &#39;main@sha1:cfe1c35724883dce2eaf428f144faeb3da27873b&#39;
</span></code></pre></div>
</div>
</div>
</div>
<p>Surtout, nous devrions voir nos applications 'foo' et 'bar' dÃ©ployÃ©es sur le cluster :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:3"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><input id="__tabbed_13_2" name="__tabbed_13" type="radio" /><input id="__tabbed_13_3" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="__tabbed_13_1">code</label><label for="__tabbed_13_2">foo output</label><label for="__tabbed_13_3">bar output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>services,deployments,pods
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>bar<span class="w"> </span>get<span class="w"> </span>services,deployments,pods
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>NAME<span class="w">          </span>TYPE<span class="w">        </span>CLUSTER-IP<span class="w">     </span>EXTERNAL-IP<span class="w">   </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">    </span>AGE
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>service/foo<span class="w">   </span>ClusterIP<span class="w">   </span><span class="m">10</span>.96.81.216<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">8080</span>/TCP<span class="w">   </span>3m30s
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>NAME<span class="w">                  </span>READY<span class="w">   </span>UP-TO-DATE<span class="w">   </span>AVAILABLE<span class="w">   </span>AGE
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>deployment.apps/foo<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>3m30s
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>NAME<span class="w">                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>pod/foo-6f6cb79d96-bdjpq<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>3m30s
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>NAME<span class="w">          </span>TYPE<span class="w">        </span>CLUSTER-IP<span class="w">    </span>EXTERNAL-IP<span class="w">   </span>PORT<span class="o">(</span>S<span class="o">)</span><span class="w">    </span>AGE
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>service/bar<span class="w">   </span>ClusterIP<span class="w">   </span><span class="m">10</span>.96.43.89<span class="w">   </span>&lt;none&gt;<span class="w">        </span><span class="m">8080</span>/TCP<span class="w">   </span>4m53s
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>NAME<span class="w">                  </span>READY<span class="w">   </span>UP-TO-DATE<span class="w">   </span>AVAILABLE<span class="w">   </span>AGE
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>deployment.apps/bar<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span><span class="m">1</span><span class="w">            </span><span class="m">1</span><span class="w">           </span>4m53s
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>NAME<span class="w">                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>pod/bar-764bd8d889-8wqq2<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>4m53s
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="imagerepository">ImageRepository</h3>
<p>Nos deux applications <em><em>'foo'</em></em> et <em><em>'bar'</em></em> utilisent une mÃªme image Docker ("<strong>e2e-test-images/agnhost</strong>") et nous aimerions qu'elle soit mise Ã  jour automatiquement si une nouvelle version venait Ã  Ãªtre publiÃ©e.
La mise en place d'un tel process d'automatisation nÃ©cessite la dÃ©finition prÃ©alable d'un <strong>'ImageRepository'</strong> auquel nous associerons une <strong>'ImagePolicy'</strong>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="14:3"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><input id="__tabbed_14_2" name="__tabbed_14" type="radio" /><input id="__tabbed_14_3" name="__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="__tabbed_14_1">code</label><label for="__tabbed_14_2">'foo' ImagePolicy</label><label for="__tabbed_14_3">'bar' ImagePolicy</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GITHUB_USERNAME</span><span class="o">=</span>papafrancky
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>flux<span class="w"> </span>create<span class="w"> </span>image<span class="w"> </span>repository<span class="w"> </span>agnhost<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">  </span>--image<span class="o">=</span>registry.k8s.io/e2e-test-images/agnhost<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="w">  </span>--interval<span class="o">=</span>5m<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="w">  </span>--namespace<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/foo/agnhost.imagerepository.yaml
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>flux<span class="w"> </span>create<span class="w"> </span>image<span class="w"> </span>repository<span class="w"> </span>agnhost<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="w">  </span>--image<span class="o">=</span>registry.k8s.io/e2e-test-images/agnhost<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="w">  </span>--interval<span class="o">=</span>5m<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="w">  </span>--namespace<span class="o">=</span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/bar/agnhost.imagerepository.yaml
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: added image repository for foo and bar apps.&quot;</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>git<span class="w"> </span>push
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>---
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta2
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>kind:<span class="w"> </span>ImageRepository
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>metadata:
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>spec:
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">  </span>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">  </span>interval:<span class="w"> </span>5m0s
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>---
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta2
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>kind:<span class="w"> </span>ImageRepository
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>metadata:
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>spec:
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">  </span>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">  </span>interval:<span class="w"> </span>5m0s
</span></code></pre></div>
</div>
</div>
</div>
<p>VÃ©rifions la bonne crÃ©ation des <em>'ImagePolicies'</em>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:3"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><input id="__tabbed_15_2" name="__tabbed_15" type="radio" /><input id="__tabbed_15_3" name="__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="__tabbed_15_1">code</label><label for="__tabbed_15_2">foo ImageRepository</label><label for="__tabbed_15_3">bar ImageRepository</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>imagerepository<span class="w"> </span>agnhost<span class="w"> </span>-o<span class="w"> </span>yaml
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>bar<span class="w"> </span>get<span class="w"> </span>imagerepository<span class="w"> </span>agnhost<span class="w"> </span>-o<span class="w"> </span>yaml
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta2
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>kind:<span class="w"> </span>ImageRepository
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>metadata:
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">  </span>creationTimestamp:<span class="w"> </span><span class="s2">&quot;2024-04-27T09:52:39Z&quot;</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">  </span>finalizers:
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">  </span>-<span class="w"> </span>finalizers.fluxcd.io
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">  </span>generation:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">  </span>labels:
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">    </span>kustomize.toolkit.fluxcd.io/name:<span class="w"> </span>flux-system
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">    </span>kustomize.toolkit.fluxcd.io/namespace:<span class="w"> </span>flux-system
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">  </span>resourceVersion:<span class="w"> </span><span class="s2">&quot;1305975&quot;</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">  </span>uid:<span class="w"> </span>d078ca2e-f277-4d29-bdd3-ef140d6e34a8
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>spec:
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">  </span>exclusionList:
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="w">  </span>-<span class="w"> </span>^.*<span class="se">\.</span>sig$
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="w">  </span>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="w">  </span>interval:<span class="w"> </span>5m0s
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="w">  </span>provider:<span class="w"> </span>generic
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>status:
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="w">  </span>canonicalImageName:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="w">  </span>conditions:
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="w">  </span>-<span class="w"> </span>lastTransitionTime:<span class="w"> </span><span class="s2">&quot;2024-04-27T09:52:39Z&quot;</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="w">    </span>message:<span class="w"> </span><span class="s1">&#39;successful scan: found 27 tags&#39;</span>
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="w">    </span>observedGeneration:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-42-27"><a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="w">    </span>reason:<span class="w"> </span>Succeeded
</span><span id="__span-42-28"><a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="w">    </span>status:<span class="w"> </span><span class="s2">&quot;True&quot;</span>
</span><span id="__span-42-29"><a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="w">    </span>type:<span class="w"> </span>Ready
</span><span id="__span-42-30"><a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="w">  </span>lastScanResult:
</span><span id="__span-42-31"><a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a><span class="w">    </span>latestTags:
</span><span id="__span-42-32"><a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.9&quot;</span>
</span><span id="__span-42-33"><a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.51&quot;</span>
</span><span id="__span-42-34"><a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.50&quot;</span>
</span><span id="__span-42-35"><a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.48&quot;</span>
</span><span id="__span-42-36"><a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.47&quot;</span>
</span><span id="__span-42-37"><a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.45&quot;</span>
</span><span id="__span-42-38"><a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.44&quot;</span>
</span><span id="__span-42-39"><a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.43&quot;</span>
</span><span id="__span-42-40"><a id="__codelineno-42-40" name="__codelineno-42-40" href="#__codelineno-42-40"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.41&quot;</span>
</span><span id="__span-42-41"><a id="__codelineno-42-41" name="__codelineno-42-41" href="#__codelineno-42-41"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.40&quot;</span>
</span><span id="__span-42-42"><a id="__codelineno-42-42" name="__codelineno-42-42" href="#__codelineno-42-42"></a><span class="w">    </span>scanTime:<span class="w"> </span><span class="s2">&quot;2024-04-27T09:52:39Z&quot;</span>
</span><span id="__span-42-43"><a id="__codelineno-42-43" name="__codelineno-42-43" href="#__codelineno-42-43"></a><span class="w">    </span>tagCount:<span class="w"> </span><span class="m">27</span>
</span><span id="__span-42-44"><a id="__codelineno-42-44" name="__codelineno-42-44" href="#__codelineno-42-44"></a><span class="w">  </span>observedExclusionList:
</span><span id="__span-42-45"><a id="__codelineno-42-45" name="__codelineno-42-45" href="#__codelineno-42-45"></a><span class="w">  </span>-<span class="w"> </span>^.*<span class="se">\.</span>sig$
</span><span id="__span-42-46"><a id="__codelineno-42-46" name="__codelineno-42-46" href="#__codelineno-42-46"></a><span class="w">  </span>observedGeneration:<span class="w"> </span><span class="m">1</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta2
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>kind:<span class="w"> </span>ImageRepository
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>metadata:
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">  </span>creationTimestamp:<span class="w"> </span><span class="s2">&quot;2024-04-27T09:52:38Z&quot;</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">  </span>finalizers:
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">  </span>-<span class="w"> </span>finalizers.fluxcd.io
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">  </span>generation:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">  </span>labels:
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">    </span>kustomize.toolkit.fluxcd.io/name:<span class="w"> </span>flux-system
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">    </span>kustomize.toolkit.fluxcd.io/namespace:<span class="w"> </span>flux-system
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">  </span>resourceVersion:<span class="w"> </span><span class="s2">&quot;1305978&quot;</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="w">  </span>uid:<span class="w"> </span>57f01130-5ef2-42e2-be24-5509c5232898
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>spec:
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="w">  </span>exclusionList:
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="w">  </span>-<span class="w"> </span>^.*<span class="se">\.</span>sig$
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="w">  </span>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a><span class="w">  </span>interval:<span class="w"> </span>5m0s
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a><span class="w">  </span>provider:<span class="w"> </span>generic
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>status:
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a><span class="w">  </span>canonicalImageName:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a><span class="w">  </span>conditions:
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="w">  </span>-<span class="w"> </span>lastTransitionTime:<span class="w"> </span><span class="s2">&quot;2024-04-27T09:52:39Z&quot;</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="w">    </span>message:<span class="w"> </span><span class="s1">&#39;successful scan: found 27 tags&#39;</span>
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a><span class="w">    </span>observedGeneration:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-43-27"><a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a><span class="w">    </span>reason:<span class="w"> </span>Succeeded
</span><span id="__span-43-28"><a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a><span class="w">    </span>status:<span class="w"> </span><span class="s2">&quot;True&quot;</span>
</span><span id="__span-43-29"><a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a><span class="w">    </span>type:<span class="w"> </span>Ready
</span><span id="__span-43-30"><a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a><span class="w">  </span>lastScanResult:
</span><span id="__span-43-31"><a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a><span class="w">    </span>latestTags:
</span><span id="__span-43-32"><a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.9&quot;</span>
</span><span id="__span-43-33"><a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.51&quot;</span>
</span><span id="__span-43-34"><a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.50&quot;</span>
</span><span id="__span-43-35"><a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.48&quot;</span>
</span><span id="__span-43-36"><a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.47&quot;</span>
</span><span id="__span-43-37"><a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.45&quot;</span>
</span><span id="__span-43-38"><a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.44&quot;</span>
</span><span id="__span-43-39"><a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.43&quot;</span>
</span><span id="__span-43-40"><a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.41&quot;</span>
</span><span id="__span-43-41"><a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a><span class="w">    </span>-<span class="w"> </span><span class="s2">&quot;2.40&quot;</span>
</span><span id="__span-43-42"><a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a><span class="w">    </span>scanTime:<span class="w"> </span><span class="s2">&quot;2024-04-27T09:52:39Z&quot;</span>
</span><span id="__span-43-43"><a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a><span class="w">    </span>tagCount:<span class="w"> </span><span class="m">27</span>
</span><span id="__span-43-44"><a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a><span class="w">  </span>observedExclusionList:
</span><span id="__span-43-45"><a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a><span class="w">  </span>-<span class="w"> </span>^.*<span class="se">\.</span>sig$
</span><span id="__span-43-46"><a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a><span class="w">  </span>observedGeneration:<span class="w"> </span><span class="m">1</span>
</span></code></pre></div>
</div>
</div>
</div>
<p>Nous pouvons d'ores et dÃ©jÃ  constater que nous n'utilisons pas la version la plus rÃ©cente de l'image <strong><em>'e2e-test-images/agnhost'</em></strong>.</p>
<h3 id="imagepolicy">ImagePolicy</h3>
<ul>
<li>nous utilisons la version <strong>2.39</strong> :</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="16:2"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><input id="__tabbed_16_2" name="__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="__tabbed_16_1">code</label><label for="__tabbed_16_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>deployment<span class="w"> </span>foo<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.template.spec.containers[].image}&#39;</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>registry.k8s.io/e2e-test-images/agnhost:2.39
</span></code></pre></div>
</div>
</div>
</div>
<ul>
<li>la version la plus rÃ©cente est la <strong>2.51</strong> :</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="17:2"><input checked="checked" id="__tabbed_17_1" name="__tabbed_17" type="radio" /><input id="__tabbed_17_2" name="__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="__tabbed_17_1">code</label><label for="__tabbed_17_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>imagerepository<span class="w"> </span>agnhost<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.lastScanResult.latestTags}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.&#39;</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="o">[</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">  </span><span class="s2">&quot;2.9&quot;</span>,
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">  </span><span class="s2">&quot;2.51&quot;</span>,
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">  </span><span class="s2">&quot;2.50&quot;</span>,
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">  </span><span class="s2">&quot;2.48&quot;</span>,
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">  </span><span class="s2">&quot;2.47&quot;</span>,
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">  </span><span class="s2">&quot;2.45&quot;</span>,
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">  </span><span class="s2">&quot;2.44&quot;</span>,
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">  </span><span class="s2">&quot;2.43&quot;</span>,
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">  </span><span class="s2">&quot;2.41&quot;</span>,
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="w">  </span><span class="s2">&quot;2.40&quot;</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="o">]</span>
</span></code></pre></div>
</div>
</div>
</div>
<p>Imaginons que nous souhaitions disposer de l'image 2.4.x la plus rÃ©cente. Nous pouvons demander Ã  FluxCD de gÃ©rer ces mises Ã  jour automatiquement en dÃ©finissant une <strong><em>'ImagePolicy'</em></strong> distincte pour les <strong><em>'ImageRepository'</em></strong> <em>'agnhost'</em> de nos applications <em>'foo'</em> et <em>'bar'</em>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>https://github.com/Masterminds/semver#checking-version-constraints</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Les images dans le dÃ©pÃ´t ne sont suivent pas le versionnement 'SemVer'. Nous devons ici jouer avec une expression rÃ©guliÃ¨re et un tri croissant pour arriver Ã  nos fins.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="18:3"><input checked="checked" id="__tabbed_18_1" name="__tabbed_18" type="radio" /><input id="__tabbed_18_2" name="__tabbed_18" type="radio" /><input id="__tabbed_18_3" name="__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="__tabbed_18_1">code</label><label for="__tabbed_18_2">foo ImagePolicy</label><label for="__tabbed_18_3">bar ImagePolicy</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>export LOCAL_GITHUB_REPOS=&quot;${HOME}/code/github&quot;
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>export GITHUB_USERNAME=papafrancky
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>cd ${LOCAL_GITHUB_REPOS}/k8s-kind-fluxcd
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>flux create image policy agnhost \
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>  --image-ref=agnhost \
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>  --namespace=foo \
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>  --select-numeric asc \
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>  --filter-regex=&#39;\d\.\d&#39; \
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>  --export &gt; apps/foo/agnhost.imagepolicy.yaml
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>flux create image policy agnhost \
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>--image-ref=agnhost \
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>--namespace=bar \
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>--select-numeric asc \
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>--filter-regex=&#39;\d\.\d&#39; \
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>--export &gt; apps/bar/agnhost.imagepolicy.yaml
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>git add .
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>git commit -m &quot;feat: defined an image policy for foo and bar apps.&quot;
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>git push
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>flux reconcile kustomization flux-system --with-source
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>---
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta2
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>kind:<span class="w"> </span>ImagePolicy
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>metadata:
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>spec:
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">  </span>imageRepositoryRef:
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">    </span>name:<span class="w"> </span>agnhost
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">  </span>filterTags:
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">    </span>pattern:<span class="w"> </span><span class="s1">&#39;\d\.\d\d&#39;</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">    </span>extract:<span class="w"> </span><span class="s2">&quot;&quot;</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">  </span>policy:
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="w">    </span>numerical:
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">      </span>order:<span class="w"> </span>asc
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>---
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta2
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>kind:<span class="w"> </span>ImagePolicy
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>metadata:
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>spec:
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">  </span>imageRepositoryRef:
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">    </span>name:<span class="w"> </span>agnhost
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">  </span>filterTags:
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">    </span>pattern:<span class="w"> </span><span class="s1">&#39;\d\.\d\d&#39;</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">    </span>extract:<span class="w"> </span><span class="s2">&quot;&quot;</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="w">  </span>policy:
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">    </span>numerical:
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">      </span>order:<span class="w"> </span>asc
</span></code></pre></div>
</div>
</div>
</div>
<p>VÃ©rifions la bonne crÃ©ation des Image Policies :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="19:2"><input checked="checked" id="__tabbed_19_1" name="__tabbed_19" type="radio" /><input id="__tabbed_19_2" name="__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="__tabbed_19_1">code</label><label for="__tabbed_19_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>ImagePolicy<span class="w"> </span>-A
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>NAMESPACE<span class="w">   </span>NAME<span class="w">      </span>LATESTIMAGE
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>bar<span class="w">         </span>agnhost<span class="w">   </span>registry.k8s.io/e2e-test-images/agnhost:2.51
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>foo<span class="w">         </span>agnhost<span class="w">   </span>registry.k8s.io/e2e-test-images/agnhost:2.51
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="marquage-des-manifests-de-deploiement-de-de-foo-et-bar">Marquage des manifests de dÃ©ploiement de de 'foo' et 'bar'</h3>
<p>Nous devons maintenant indiquer Ã  FluxCD oÃ¹ mettre la version de l'image Ã  jour dans les manifests de l'application 'foobar'.
En effet, si FluxCD est capable de dÃ©tecter une nouvelle version de l'image conforme Ã  notre politique de mise Ã  jour (dans notre cas, toutes les versions 2.x), il doit aussi mettre le code de dÃ©ploiement de l'application.</p>
<p>Dans le cas de nos applications, l'image Docker et sa version sont dÃ©finis dans les manifests qui dÃ©crivent les <em>'deployments'</em> : </p>
<ul>
<li>${LOCAL_GITHUB_REPOS}/k8s-kind-apps/foo/<strong>deployment.yaml</strong>;</li>
<li>${LOCAL_GITHUB_REPOS}/k8s-kind-apps/bar/<strong>deployment.yaml</strong>.</li>
</ul>
<p>Ajoutons un marqueur pour permettre Ã  FluxCD de mettre la version de l'image Ã  jour :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="20:1"><input checked="checked" id="__tabbed_20_1" name="__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="__tabbed_20_1">code</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GITHUB_USERNAME</span><span class="o">=</span>papafrancky
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-apps
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>gsed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/agnhost:2\.39/agnhost:2\.39 # {&quot;$imagepolicy&quot;: &quot;foo:agnhost&quot;}/&#39;</span><span class="w"> </span>foo/deployment.yaml
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>gsed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/agnhost:2\.39/agnhost:2\.39 # {&quot;$imagepolicy&quot;: &quot;bar:agnhost&quot;}/&#39;</span><span class="w"> </span>bar/deployment.yaml
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: added a marker on foobar&#39;s pods manifests.&quot;</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>git<span class="w"> </span>push
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>flux<span class="w"> </span>reconcile<span class="w"> </span>kustomization<span class="w"> </span>flux-system<span class="w"> </span>--with-source
</span></code></pre></div>
</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">Configure image update for custom resources</p>
<p>https://fluxcd.io/flux/guides/image-update/#configure-image-update-for-custom-resources</p>
</div>
<p>Le format du marqueur de l'image policy est le suivant :
<div class="language-sh highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>*<span class="w"> </span><span class="o">{</span><span class="s2">&quot;</span><span class="nv">$imagepolicy</span><span class="s2">&quot;</span>:<span class="w"> </span><span class="s2">&quot;&lt;policy-namespace&gt;:&lt;policy-name&gt;&quot;</span><span class="o">}</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>*<span class="w"> </span><span class="o">{</span><span class="s2">&quot;</span><span class="nv">$imagepolicy</span><span class="s2">&quot;</span>:<span class="w"> </span><span class="s2">&quot;&lt;policy-namespace&gt;:&lt;policy-name&gt;:tag&quot;</span><span class="o">}</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>*<span class="w"> </span><span class="o">{</span><span class="s2">&quot;</span><span class="nv">$imagepolicy</span><span class="s2">&quot;</span>:<span class="w"> </span><span class="s2">&quot;&lt;policy-namespace&gt;:&lt;policy-name&gt;:name&quot;</span><span class="o">}</span>
</span></code></pre></div></p>
<div class="tabbed-set tabbed-alternate" data-tabs="21:2"><input checked="checked" id="__tabbed_21_1" name="__tabbed_21" type="radio" /><input id="__tabbed_21_2" name="__tabbed_21" type="radio" /><div class="tabbed-labels"><label for="__tabbed_21_1">'foo' deployment.yaml</label><label for="__tabbed_21_2">'bar' deployment.yaml</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>apiVersion:<span class="w"> </span>apps/v1
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>kind:<span class="w"> </span>Deployment
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>metadata:
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">  </span>name:<span class="w"> </span>foo
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">  </span>labels:
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">    </span>app:<span class="w"> </span>foo
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>spec:
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">  </span>replicas:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">  </span>selector:
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">    </span>matchLabels:
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">      </span>app:<span class="w"> </span>foo
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">  </span>template:
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">    </span>metadata:
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="w">      </span>labels:
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="w">        </span>app:<span class="w"> </span>foo
</span><span id="__span-55-17"><a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a><span class="w">    </span>spec:
</span><span id="__span-55-18"><a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="w">      </span>containers:
</span><span id="__span-55-19"><a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="w">      </span>-<span class="w"> </span>name:<span class="w"> </span>agnhost
</span><span id="__span-55-20"><a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="w">        </span>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost:2.39<span class="w"> </span><span class="c1"># {&quot;$imagepolicy&quot;: &quot;foobar:foobar&quot;}</span>
</span><span id="__span-55-21"><a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a><span class="w">        </span>command:
</span><span id="__span-55-22"><a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a><span class="w">        </span>-<span class="w"> </span>/agnhost
</span><span id="__span-55-23"><a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a><span class="w">        </span>-<span class="w"> </span>netexec
</span><span id="__span-55-24"><a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a><span class="w">        </span>-<span class="w"> </span>--http-port
</span><span id="__span-55-25"><a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a><span class="w">        </span>-<span class="w"> </span><span class="s2">&quot;8080&quot;</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>apiVersion:<span class="w"> </span>apps/v1
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>kind:<span class="w"> </span>Deployment
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>metadata:
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">  </span>name:<span class="w"> </span>bar
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">  </span>labels:
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">    </span>app:<span class="w"> </span>bar
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>spec:
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">  </span>replicas:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">  </span>selector:
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">    </span>matchLabels:
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="w">      </span>app:<span class="w"> </span>bar
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="w">  </span>template:
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="w">    </span>metadata:
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a><span class="w">      </span>labels:
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="w">        </span>app:<span class="w"> </span>bar
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="w">    </span>spec:
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a><span class="w">      </span>containers:
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="w">      </span>-<span class="w"> </span>name:<span class="w"> </span>agnhost
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a><span class="w">        </span>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost:2.39<span class="w"> </span><span class="c1"># {&quot;$imagepolicy&quot;: &quot;foobar:foobar&quot;}</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a><span class="w">        </span>command:
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="w">        </span>-<span class="w"> </span>/agnhost
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="w">        </span>-<span class="w"> </span>netexec
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a><span class="w">        </span>-<span class="w"> </span>--http-port
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a><span class="w">        </span>-<span class="w"> </span><span class="s2">&quot;8080&quot;</span>
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="image-update-automation">Image Update Automation</h3>
<p>Il ne nous reste plus qu'Ã  tout mettre en musique en crÃ©ant une 'ImageUpdateAutomation' pour chacune de nos applications.</p>
<div class="admonition info">
<p class="admonition-title">flux create image update</p>
<p>https://fluxcd.io/flux/cmd/flux_create_image_update/#examples</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="22:3"><input checked="checked" id="__tabbed_22_1" name="__tabbed_22" type="radio" /><input id="__tabbed_22_2" name="__tabbed_22" type="radio" /><input id="__tabbed_22_3" name="__tabbed_22" type="radio" /><div class="tabbed-labels"><label for="__tabbed_22_1">code</label><label for="__tabbed_22_2">'foo' ImageUpdateAutomation</label><label for="__tabbed_22_3">'bar' ImageUpdateAutomation</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>flux<span class="w"> </span>create<span class="w"> </span>image<span class="w"> </span>update<span class="w"> </span>agnhost<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">    </span>--namespace<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="w">    </span>--git-repo-ref<span class="o">=</span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">    </span>--git-repo-path<span class="o">=</span><span class="s2">&quot;./foo&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">    </span>--checkout-branch<span class="o">=</span>main<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="w">    </span>--author-name<span class="o">=</span>FluxCD<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">    </span>--author-email<span class="o">=</span><span class="m">19983231</span>-papafrancky@users.noreply.github.com<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="w">    </span>--commit-template<span class="o">=</span><span class="s2">&quot;{{range .Updated.Images}}{{println .}}{{end}}&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="w">    </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/foo/imageupdateautomation.yaml
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>flux<span class="w"> </span>create<span class="w"> </span>image<span class="w"> </span>update<span class="w"> </span>agnhost<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="w">    </span>--namespace<span class="o">=</span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="w">    </span>--git-repo-ref<span class="o">=</span>k8s-kind-apps<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="w">    </span>--git-repo-path<span class="o">=</span><span class="s2">&quot;./bar&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="w">    </span>--checkout-branch<span class="o">=</span>main<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="w">    </span>--author-name<span class="o">=</span>FluxCD<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="w">    </span>--author-email<span class="o">=</span><span class="m">19983231</span>-papafrancky@users.noreply.github.com<span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-22"><a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a><span class="w">    </span>--commit-template<span class="o">=</span><span class="s2">&quot;{{range .Updated.Images}}{{println .}}{{end}}&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-57-23"><a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="w">    </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/bar/imageupdateautomation.yaml
</span><span id="__span-57-24"><a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a>
</span><span id="__span-57-25"><a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-57-26"><a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: added ImageUpdateAutomations to foo and bar applications respectively.&quot;</span>
</span><span id="__span-57-27"><a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a>git<span class="w"> </span>push
</span><span id="__span-57-28"><a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a>
</span><span id="__span-57-29"><a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a>flux<span class="w"> </span>reconcile<span class="w"> </span>kustomization<span class="w"> </span>flux-system<span class="w"> </span>--with-source
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>---
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta1
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>kind:<span class="w"> </span>ImageUpdateAutomation
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>metadata:
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>spec:
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="w">  </span>git:
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="w">    </span>checkout:
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="w">      </span>ref:
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="w">        </span>branch:<span class="w"> </span>main
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="w">    </span>commit:
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="w">      </span>author:
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="w">        </span>email:<span class="w"> </span><span class="m">19983231</span>-papafrancky@users.noreply.github.com
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="w">        </span>name:<span class="w"> </span>FluxCD
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="w">      </span>messageTemplate:<span class="w"> </span><span class="s1">&#39;{{range .Updated.Images}}{{println .}}{{end}}&#39;</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="w">  </span>interval:<span class="w"> </span>1m0s
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="w">  </span>sourceRef:
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a><span class="w">    </span>kind:<span class="w"> </span>GitRepository
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a><span class="w">    </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a><span class="w">  </span>update:
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a><span class="w">    </span>path:<span class="w"> </span>./foo
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a><span class="w">    </span>strategy:<span class="w"> </span>Setters
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>---
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta1
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>kind:<span class="w"> </span>ImageUpdateAutomation
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>metadata:
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>spec:
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">  </span>git:
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">    </span>checkout:
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">      </span>ref:
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">        </span>branch:<span class="w"> </span>main
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">    </span>commit:
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">      </span>author:
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">        </span>email:<span class="w"> </span><span class="m">19983231</span>-papafrancky@users.noreply.github.com
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a><span class="w">        </span>name:<span class="w"> </span>FluxCD
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="w">      </span>messageTemplate:<span class="w"> </span><span class="s1">&#39;{{range .Updated.Images}}{{println .}}{{end}}&#39;</span>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="w">  </span>interval:<span class="w"> </span>1m0s
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="w">  </span>sourceRef:
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="w">    </span>kind:<span class="w"> </span>GitRepository
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a><span class="w">    </span>name:<span class="w"> </span>k8s-kind-apps
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="w">  </span>update:
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a><span class="w">    </span>path:<span class="w"> </span>./bar
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="w">    </span>strategy:<span class="w"> </span>Setters
</span></code></pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">DÃ©finir son adresse email de commit</p>
<p>https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-personal-account-on-github/managing-email-preferences/setting-your-commit-email-address#about-commit-email-addresses</p>
</div>
<div class="admonition note">
<p class="admonition-title">Comment rÃ©cupÃ©rer l'ID de son compte GitHub</p>
<p>https://api.github.com/users/${GITHUB_USERNAME}</p>
</div>
<p>Surveillons la mise Ã  jour des images :</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--all-namespaces<span class="w"> </span>-l<span class="w"> </span><span class="s1">&#39;app in (foo, bar)&#39;</span><span class="w">  </span>-w
</span></code></pre></div>
<p>VÃ©rifions la version des images utilisÃ©es :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="23:3"><input checked="checked" id="__tabbed_23_1" name="__tabbed_23" type="radio" /><input id="__tabbed_23_2" name="__tabbed_23" type="radio" /><input id="__tabbed_23_3" name="__tabbed_23" type="radio" /><div class="tabbed-labels"><label for="__tabbed_23_1">code</label><label for="__tabbed_23_2">avant</label><label for="__tabbed_23_3">aprÃ¨s</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>--all-namespaces<span class="w"> </span>-l<span class="w"> </span><span class="s1">&#39;app in (foo, bar)&#39;</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[*].spec.containers[*].image}&#39;</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>registry.k8s.io/e2e-test-images/agnhost:2.39<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost:2.39%
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-text highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>registry.k8s.io/e2e-test-images/agnhost:2.51 registry.k8s.io/e2e-test-images/agnhost:2.51%
</span></code></pre></div>
</div>
</div>
</div>
<p>Enfin, assurons-nous que FluxCD ait bien pu modifier le <em><em>deployment</em></em> des applications pour prendre la version de l'image la plus rÃ©cente en compte :</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Nous devons mettre Ã  jour notre copie locale du dÃ©pÃ´t des applications pour constater la boone rÃ©Ã©criture de FluxCD.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="24:2"><input checked="checked" id="__tabbed_24_1" name="__tabbed_24" type="radio" /><input id="__tabbed_24_2" name="__tabbed_24" type="radio" /><div class="tabbed-labels"><label for="__tabbed_24_1">code</label><label for="__tabbed_24_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="w">   </span><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w">   </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-apps
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">   </span>git<span class="w"> </span>fetch
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">   </span>git<span class="w"> </span>pull
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w">   </span>cat<span class="w"> </span>*/deployment.yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>image
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>Mise<span class="w"> </span>Ã <span class="w"> </span>jour<span class="w"> </span>17cb1e2..0925cae
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>Fast-forward
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="w"> </span>bar/deployment.yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>+-
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w"> </span>foo/deployment.yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>+-
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w"> </span><span class="m">2</span><span class="w"> </span>files<span class="w"> </span>changed,<span class="w"> </span><span class="m">2</span><span class="w"> </span>insertions<span class="o">(</span>+<span class="o">)</span>,<span class="w"> </span><span class="m">2</span><span class="w"> </span>deletions<span class="o">(</span>-<span class="o">)</span>
</span></code></pre></div>
</div>
</div>
</div>
<p>Les manifests ont bien Ã©tÃ© modifiÃ©s.
VÃ©rifions la mise Ã  jour de la version des images :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="25:2"><input checked="checked" id="__tabbed_25_1" name="__tabbed_25" type="radio" /><input id="__tabbed_25_2" name="__tabbed_25" type="radio" /><div class="tabbed-labels"><label for="__tabbed_25_1">code</label><label for="__tabbed_25_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>cat<span class="w"> </span>*/deployment.yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>image
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost:2.51<span class="w"> </span><span class="c1"># {&quot;$imagepolicy&quot;: &quot;bar:agnhost&quot;}</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>image:<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost:2.51<span class="w"> </span><span class="c1"># {&quot;$imagepolicy&quot;: &quot;foo:agnhost&quot;}</span>
</span></code></pre></div>
</div>
</div>
</div>
<p>Les images sont passÃ©es de la version initiale (2.39) Ã  la version la plus rÃ©cente conforme Ã  l'ImagePolicy (2.51).</p>
<p>Tout fonctionne comme attendu ! <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M464 256a208 208 0 1 0-416 0 208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0 256 256 0 1 1-512 0zm130.7 57.9c-4.2-13.6 7.1-25.9 21.3-25.9h212.5c14.2 0 25.5 12.4 21.3 25.9C369 368.4 318.2 408 258.2 408s-110.8-39.6-127.5-94.1zM144.4 192a32 32 0 1 1 64 0 32 32 0 1 1-64 0zm165.8 21.7c-7.6 8.1-20.2 8.5-28.3.9s-8.5-20.2-.9-28.3c14.5-15.5 35.2-22.3 54.6-22.3s40.1 6.8 54.6 22.3c7.6 8.1 7.1 20.7-.9 28.3s-20.7 7.1-28.3-.9c-5.5-5.8-14.8-9.7-25.4-9.7s-19.9 3.8-25.4 9.7z"/></svg></span></p>
<hr />
<h3 id="exposition-des-applications">Exposition des applications</h3>
<p>L'exposition des applications hÃ©bergÃ©es sur le cluster doit Ãªtre gÃ©rÃ©e en dehors des applications. Nous allons dÃ©finir les rÃ¨gles de routage de notre Ingress controller Nginx dans le dÃ©pÃ´t GitHub dÃ©diÃ© Ã  FluxCD :</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Bien que le contrÃ´leur Ingress puisse Ãªtre dÃ©ployÃ© dans n'importe quel namespace, il est gÃ©nÃ©ralement dÃ©ployÃ© dans un namespace distinct de vos services d'application (par exemple, ingress ou kube-system). Il peut voir les rÃ¨gles Ingress dans tous les autres espaces de noms et les rÃ©cupÃ©rer. Cependant, chaque rÃ¨gle Ingress doit rÃ©sider dans l'espace de noms oÃ¹ rÃ©side l'application qu'elle configure.</p>
</div>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; apps/foo/ingress.yaml</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="s">---</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="s">apiVersion: networking.k8s.io/v1</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="s">kind: Ingress</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="s">metadata:</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="s">  name: foo</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="s">  namespace: foo</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="s">  annotations:</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="s">    nginx.ingress.kubernetes.io/rewrite-target: /$2</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="s">spec:</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="s">  rules:</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="s">  - http:</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="s">      paths:</span>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="s">      - pathType: Prefix</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="s">        path: /foo(/|$)(.*)</span>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="s">        backend:</span>
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a><span class="s">          service:</span>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a><span class="s">            name: foo</span>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="s">            port:</span>
</span><span id="__span-68-24"><a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a><span class="s">              number: 8080</span>
</span><span id="__span-68-25"><a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a><span class="s">EOF</span>
</span><span id="__span-68-26"><a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a>
</span><span id="__span-68-27"><a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>cat<span class="w"> </span><span class="s">&lt;&lt; EOF &gt;&gt; apps/bar/ingress.yaml</span>
</span><span id="__span-68-28"><a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a><span class="s">---</span>
</span><span id="__span-68-29"><a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a><span class="s">apiVersion: networking.k8s.io/v1</span>
</span><span id="__span-68-30"><a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a><span class="s">kind: Ingress</span>
</span><span id="__span-68-31"><a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a><span class="s">metadata:</span>
</span><span id="__span-68-32"><a id="__codelineno-68-32" name="__codelineno-68-32" href="#__codelineno-68-32"></a><span class="s">  name: bar</span>
</span><span id="__span-68-33"><a id="__codelineno-68-33" name="__codelineno-68-33" href="#__codelineno-68-33"></a><span class="s">  namespace: bar</span>
</span><span id="__span-68-34"><a id="__codelineno-68-34" name="__codelineno-68-34" href="#__codelineno-68-34"></a><span class="s">  annotations:</span>
</span><span id="__span-68-35"><a id="__codelineno-68-35" name="__codelineno-68-35" href="#__codelineno-68-35"></a><span class="s">    nginx.ingress.kubernetes.io/rewrite-target: /$2</span>
</span><span id="__span-68-36"><a id="__codelineno-68-36" name="__codelineno-68-36" href="#__codelineno-68-36"></a><span class="s">spec:</span>
</span><span id="__span-68-37"><a id="__codelineno-68-37" name="__codelineno-68-37" href="#__codelineno-68-37"></a><span class="s">  rules:</span>
</span><span id="__span-68-38"><a id="__codelineno-68-38" name="__codelineno-68-38" href="#__codelineno-68-38"></a><span class="s">  - http:</span>
</span><span id="__span-68-39"><a id="__codelineno-68-39" name="__codelineno-68-39" href="#__codelineno-68-39"></a><span class="s">      paths:</span>
</span><span id="__span-68-40"><a id="__codelineno-68-40" name="__codelineno-68-40" href="#__codelineno-68-40"></a><span class="s">      - pathType: Prefix</span>
</span><span id="__span-68-41"><a id="__codelineno-68-41" name="__codelineno-68-41" href="#__codelineno-68-41"></a><span class="s">        path: /bar(/|$)(.*)</span>
</span><span id="__span-68-42"><a id="__codelineno-68-42" name="__codelineno-68-42" href="#__codelineno-68-42"></a><span class="s">        backend:</span>
</span><span id="__span-68-43"><a id="__codelineno-68-43" name="__codelineno-68-43" href="#__codelineno-68-43"></a><span class="s">          service:</span>
</span><span id="__span-68-44"><a id="__codelineno-68-44" name="__codelineno-68-44" href="#__codelineno-68-44"></a><span class="s">            name: bar</span>
</span><span id="__span-68-45"><a id="__codelineno-68-45" name="__codelineno-68-45" href="#__codelineno-68-45"></a><span class="s">            port:</span>
</span><span id="__span-68-46"><a id="__codelineno-68-46" name="__codelineno-68-46" href="#__codelineno-68-46"></a><span class="s">              number: 8080</span>
</span><span id="__span-68-47"><a id="__codelineno-68-47" name="__codelineno-68-47" href="#__codelineno-68-47"></a><span class="s">EOF</span>
</span><span id="__span-68-48"><a id="__codelineno-68-48" name="__codelineno-68-48" href="#__codelineno-68-48"></a>
</span><span id="__span-68-49"><a id="__codelineno-68-49" name="__codelineno-68-49" href="#__codelineno-68-49"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-68-50"><a id="__codelineno-68-50" name="__codelineno-68-50" href="#__codelineno-68-50"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: setting up Ingress routes for foo and bar.&quot;</span>
</span><span id="__span-68-51"><a id="__codelineno-68-51" name="__codelineno-68-51" href="#__codelineno-68-51"></a>git<span class="w"> </span>push
</span><span id="__span-68-52"><a id="__codelineno-68-52" name="__codelineno-68-52" href="#__codelineno-68-52"></a>
</span><span id="__span-68-53"><a id="__codelineno-68-53" name="__codelineno-68-53" href="#__codelineno-68-53"></a>flux<span class="w"> </span>reconcile<span class="w"> </span>kustomization<span class="w"> </span>flux-system<span class="w"> </span>--with-source
</span></code></pre></div>
<p>Testons le bon fonctionnement de nos routes :</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>curl<span class="w"> </span>http://localhost/foo<span class="w">           </span><span class="c1"># -&gt; NOW: 2024-04-27 18:14:24.152568822 +0000 UTC m=+5403.294573418%</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>curl<span class="w"> </span>http://localhost/foo/hostname<span class="w">  </span><span class="c1"># -&gt; foo-9d658c7db-x6v84%</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>curl<span class="w"> </span>http://localhost/bar<span class="w">           </span><span class="c1"># -&gt; NOW: 2024-04-27 18:14:26.677481395 +0000 UTC m=+5108.710059928%</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>curl<span class="w"> </span>http://localhost/bar/hostname<span class="w">  </span><span class="c1"># -&gt; bar-5c7c6495ff-954bh%</span>
</span></code></pre></div>
<p>Le routage fonctionne comme attendu ! <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M464 256a208 208 0 1 0-416 0 208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0 256 256 0 1 1-512 0zm130.7 57.9c-4.2-13.6 7.1-25.9 21.3-25.9h212.5c14.2 0 25.5 12.4 21.3 25.9C369 368.4 318.2 408 258.2 408s-110.8-39.6-127.5-94.1zM144.4 192a32 32 0 1 1 64 0 32 32 0 1 1-64 0zm165.8 21.7c-7.6 8.1-20.2 8.5-28.3.9s-8.5-20.2-.9-28.3c14.5-15.5 35.2-22.3 54.6-22.3s40.1 6.8 54.6 22.3c7.6 8.1 7.1 20.7-.9 28.3s-20.7 7.1-28.3-.9c-5.5-5.8-14.8-9.7-25.4-9.7s-19.9 3.8-25.4 9.7z"/></svg></span></p>
<hr />
<h2 id="notifications-discord">Notifications Discord</h2>
<p>Nous avons configurÃ© FluxCD pour gÃ©rer automatiquement la mise Ã  jour des images de nos applications <em><em>'foo'</em></em> et <em><em>'bar'</em></em> et avons exposÃ© ces derniÃ¨res via notre Ingress controller Nginx.</p>
<p>Nous aimerions maintenant Ãªtre informÃ©s lorsqu'un changement est opÃ©rÃ© sur nos applications et allons nous y atteler dans cette partie.</p>
<p>Nous avons retenu la plateforme de messagere instantanÃ©e <strong>'Discord'</strong> car elle permet de configurer des <em><em>'webhooks'</em></em> sur des <em><em>'channels'</em></em> sans pour autant devoir payer un abonnement, comme c'est le cas par exemple avec <strong>Slack</strong>.</p>
<h3 id="installation-du-client-discord">Installation du client <em><em>'Discord'</em></em></h3>
<p>Pour l'installer, il faut accÃ©der au site web <strong>discord.com</strong> et tÃ©lÃ©charger le client :</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>https://discord.com/api/download?platform<span class="o">=</span>osx
</span></code></pre></div>
<h3 id="creation-dun-serveur-et-dun-channel-pour-chaque-application">CrÃ©ation d'un <em><em>'serveur'</em></em> et d'un <em><em>'channel'</em></em> pour chaque application</h3>
<h4 id="creation-dun-serveur-discord">CrÃ©ation d'un serveur Discord</h4>
<p>Discord permet la crÃ©ation de <em><em>'serveurs'</em></em> que nous pouvons restreindre pour notre usage personnel et qui hÃ©bergeront les <em><em>'salons'</em></em> que nous dÃ©dierons Ã  l'envoi de notifications de FluxCD concernant nos applications.</p>
<p>Une fois le client Discord dÃ©marrÃ©, cliquons sur le <strong>'+'</strong> situÃ© dasn la colonne de gauche. Nous rÃ©pondrons ensuite aux diffÃ©rentes questions et donnerons Ã  notre serveur le nom de notre cluster Kubernetes : <strong>k8s-kind</strong>.</p>
<p><img alt="Add a Discord server #1" src="../images/discord_add_server_1.png" /></p>
<p><img alt="Add a Discord server #2" src="../images/discord_add_server_2.png" /></p>
<p><img alt="Add a Discord server #3" src="../images/discord_add_server_3.png" /></p>
<p><img alt="Add a Discord server #4" src="../images/discord_add_server_4.png" /></p>
<h4 id="creation-dun-salon-dans-notre-serveur-discord">CrÃ©ation d'un salon dans notre serveur Discord</h4>
<p>Nous souhaitons crÃ©er un salon pour chacune de nos applications. La procÃ©dure Ã©tant la mÃªme pour tous les salons, nous montrerons la crÃ©ation du salon pour l'application <em><em>'foo'</em></em>. Vous devrez faire la mÃªme chose pour l'application <em><em>'bar'</em></em>.</p>
<p>SÃ©lectionnez le serveur <em><em>'k8s-kind'</em></em> dans la colonne de gauche, puis dans la partie 'salons textuels', cliquez sur le <strong>'+'</strong> :</p>
<p><img alt="Add a Discord channel #1" src="../images/discord_add_channel_1.png" /></p>
<p>PrÃ©cisez qu'il s'agit bien d'un salon textuel, prÃ©cisez son nom <em><em>'foo'</em></em> et choisissez de le rendre <strong>privÃ©</strong> :</p>
<p><img alt="Add a Discord channel #2" src="../images/discord_add_channel_2.png" /></p>
<p>Passez l'Ã©tape d'ajout de membres :</p>
<p><img alt="Add a Discord channel 3" src="../images/discord_add_channel_3.png" /></p>
<p>Votre salon est prÃªt.</p>
<h4 id="creation-dun-webhook-pour-chaque-salon">CrÃ©ation d'un <em><em>'webhook'</em></em> pour chaque salon</h4>
<p>Cliquez sur la roue dentÃ©e <em>'paramÃ¨tres'</em> Ã  droite du nom du salon, puis sur <em>'intÃ©grations'</em> et enfin sur le bouton <em>'CrÃ©er un webhook'</em>.</p>
<p><img alt="Configure a webhook #1" src="../images/discord_configure_webhook_1.png" /></p>
<p><img alt="Configure a webhook #2" src="../images/discord_configure_webhook_2.png" /></p>
<p><img alt="Configure a webhook #3" src="./images/discord_configure_webhook_3.png" /></p>
<p>Un nom lui est donnÃ© de maniÃ¨re alÃ©atoire (ex: 'Spidey Bot'). Pour changer le nom du <em>'webhook'</em> par 'FluxCD', copiez l'URL en cliquant sur le bouton idoine, et enregistrez les modifications :</p>
<p><img alt="Configure a webhook #4" src="../images/discord_configure_webhook_4.png" /></p>
<p><img alt="Configure a webhook #5" src="../images/discord_configure_webhook_5.png" /></p>
<p><strong>Nous rÃ©pÃ©tons les mÃªmes opÃ©rations pour la crÃ©ation du salon privÃ© _<em>'bar'</em>_.</strong></p>
<p>Les URLs des webhooks des salons sont les suivants :</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Salon privÃ©</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>foo</strong></td>
<td>https://discord.com/api/webhooks/1234167966258561045/z-vEpmh08xnLZHypqKsjzUQd4FwdCDvFWhKAHaJKg7k6YbuU1VfkxqLROXme7ihb8jKP</td>
</tr>
<tr>
<td style="text-align: center;"><strong>bar</strong></td>
<td>https://discord.com/api/webhooks/1234169188231413912/ppnMSjYpE-efPic1AVIGlpZW0m5p_nzj8qiaqldJgd_u_O97Rhm5FJbQLlUg9z5DBC_0</td>
</tr>
</tbody>
</table>
<h3 id="enregistrement-des-webhook-des-salons-discord">Enregistrement des webhook des salons Discord</h3>
<p>Ces informations sont considÃ©rÃ©es comme sensibles dasn la mesure oÃ¹ quiconque en disposerait pourrait publier des informations dans nos salons privÃ©s. Nous les enregistrerons dans Kubernetes comme des <em>'secrets'</em>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="26:3"><input checked="checked" id="__tabbed_26_1" name="__tabbed_26" type="radio" /><input id="__tabbed_26_2" name="__tabbed_26" type="radio" /><input id="__tabbed_26_3" name="__tabbed_26" type="radio" /><div class="tabbed-labels"><label for="__tabbed_26_1">code</label><label for="__tabbed_26_2">'foo' webhook</label><label for="__tabbed_26_3">'bar' webhook</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WEBHOOK_FOO</span><span class="o">=</span><span class="s2">&quot;https://discord.com/api/webhooks/1234167966258561045/z-vEpmh08xnLZHypqKsjzUQd4FwdCDvFWhKAHaJKg7k6YbuU1VfkxqLROXme7ihb8jKP&quot;</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WEBHOOK_BAR</span><span class="o">=</span><span class="s2">&quot;https://discord.com/api/webhooks/1234169188231413912/ppnMSjYpE-efPic1AVIGlpZW0m5p_nzj8qiaqldJgd_u_O97Rhm5FJbQLlUg9z5DBC_0&quot;</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>discord-webhook<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">address</span><span class="o">=</span><span class="si">${</span><span class="nv">WEBHOOK_FOO</span><span class="si">}</span><span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>apps/foo/discord-webhook.secret.yaml
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>bar<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>discord-webhook<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">address</span><span class="o">=</span><span class="si">${</span><span class="nv">WEBHOOK_BAR</span><span class="si">}</span><span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>apps/bar/discord-webhook.secret.yaml
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>apiVersion:<span class="w"> </span>v1
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>data:
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="w">  </span>address:<span class="w"> </span><span class="nv">aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTIzNDE2Nzk2NjI1ODU2MTA0NS96LXZFcG1oMDh4bkxaSHlwcUtzanpVUWQ0RndkQ0R2RldoS0FIYUpLZzdrNllidVUxVmZreHFMUk9YbWU3aWhiOGpLUA</span><span class="o">==</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>kind:<span class="w"> </span>Secret
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>metadata:
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="w">  </span>creationTimestamp:<span class="w"> </span>null
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="w">  </span>name:<span class="w"> </span>discord-webhook
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>apiVersion:<span class="w"> </span>v1
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>data:
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="w">  </span>address:<span class="w"> </span><span class="nv">aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTIzNDE2OTE4ODIzMTQxMzkxMi9wcG5NU2pZcEUtZWZQaWMxQVZJR2xwWlcwbTVwX256ajhxaWFxbGRKZ2RfdV9POTdSaG01RkpiUUxsVWc5ejVEQkNfMA</span><span class="o">==</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>kind:<span class="w"> </span>Secret
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>metadata:
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="w">  </span>creationTimestamp:<span class="w"> </span>null
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="w">  </span>name:<span class="w"> </span>discord-webhook
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="creation-des-notification-providers">CrÃ©ation des <em><em>'notification providers'</em></em></h3>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>https://fluxcd.io/flux/components/notification/providers/#discord</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="27:3"><input checked="checked" id="__tabbed_27_1" name="__tabbed_27" type="radio" /><input id="__tabbed_27_2" name="__tabbed_27" type="radio" /><input id="__tabbed_27_3" name="__tabbed_27" type="radio" /><div class="tabbed-labels"><label for="__tabbed_27_1">code</label><label for="__tabbed_27_2">'foo' notification provider</label><label for="__tabbed_27_3">'bar' notification provider</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>flux<span class="w"> </span>create<span class="w"> </span>alert-provider<span class="w"> </span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="w">  </span>--type<span class="o">=</span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="w">  </span>--secret-ref<span class="o">=</span>discord-webhook<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="w">  </span>--channel<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="w">  </span>--username<span class="o">=</span>FluxCD<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="w">  </span>--namespace<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/foo/notification-provider.yaml
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>flux<span class="w"> </span>create<span class="w"> </span>alert-provider<span class="w"> </span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="w">  </span>--type<span class="o">=</span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="w">  </span>--secret-ref<span class="o">=</span>discord-webhook<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="w">  </span>--channel<span class="o">=</span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="w">  </span>--username<span class="o">=</span>FluxCD<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="w">  </span>--namespace<span class="o">=</span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-74-19"><a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/bar/notification-provider.yaml
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a>---
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>apiVersion:<span class="w"> </span>notification.toolkit.fluxcd.io/v1beta2
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>kind:<span class="w"> </span>Provider
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>metadata:
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="w">  </span>name:<span class="w"> </span>discord
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>spec:
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="w">  </span>channel:<span class="w"> </span>foo
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="w">  </span>secretRef:
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="w">    </span>name:<span class="w"> </span>discord-webhook
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="w">  </span>type:<span class="w"> </span>discord
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="w">  </span>username:<span class="w"> </span>FluxCD
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>---
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>apiVersion:<span class="w"> </span>notification.toolkit.fluxcd.io/v1beta2
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>kind:<span class="w"> </span>Provider
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>metadata:
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="w">  </span>name:<span class="w"> </span>discord
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>spec:
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a><span class="w">  </span>channel:<span class="w"> </span>bar
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="w">  </span>secretRef:
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a><span class="w">    </span>name:<span class="w"> </span>discord-webhook
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a><span class="w">  </span>type:<span class="w"> </span>discord
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a><span class="w">  </span>username:<span class="w"> </span>FluxCD
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="configuration-des-alertes-discord">Configuration des alertes Discord</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="28:3"><input checked="checked" id="__tabbed_28_1" name="__tabbed_28" type="radio" /><input id="__tabbed_28_2" name="__tabbed_28" type="radio" /><input id="__tabbed_28_3" name="__tabbed_28" type="radio" /><div class="tabbed-labels"><label for="__tabbed_28_1">code</label><label for="__tabbed_28_2">'foo' alert</label><label for="__tabbed_28_3">'bar' alert</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>flux<span class="w"> </span>create<span class="w"> </span>alert<span class="w"> </span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="w">  </span>--event-severity<span class="o">=</span>info<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="w">  </span>--event-source<span class="o">=</span><span class="s1">&#39;GitRepository/*,Kustomization/*,ImageRepository/*,ImagePolicy/*,HelmRepository/*,HelmRelease/*&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="w">  </span>--provider-ref<span class="o">=</span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="w">  </span>--namespace<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/foo/notification-alert.yaml
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>flux<span class="w"> </span>create<span class="w"> </span>alert<span class="w"> </span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a><span class="w">  </span>--event-severity<span class="o">=</span>info<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a><span class="w">  </span>--event-source<span class="o">=</span><span class="s1">&#39;GitRepository/*,Kustomization/*,ImageRepository/*,ImagePolicy/*,HelmRepository/*,HelmRelease/*&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a><span class="w">  </span>--provider-ref<span class="o">=</span>discord<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a><span class="w">  </span>--namespace<span class="o">=</span>bar<span class="w"> </span><span class="se">\</span>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a><span class="w">  </span>--export<span class="w"> </span>&gt;<span class="w"> </span>apps/bar/notification-alert.yaml
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>---
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>apiVersion:<span class="w"> </span>notification.toolkit.fluxcd.io/v1beta2
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>kind:<span class="w"> </span>Alert
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>metadata:
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="w">  </span>name:<span class="w"> </span>discord
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>spec:
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="w">  </span>eventSeverity:<span class="w"> </span>info
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="w">  </span>eventSources:
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>GitRepository
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>Kustomization
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>ImageRepository
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>ImagePolicy
</span><span id="__span-78-17"><a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-78-18"><a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>HelmRepository
</span><span id="__span-78-19"><a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-78-20"><a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>HelmRelease
</span><span id="__span-78-21"><a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-78-22"><a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a><span class="w">  </span>providerRef:
</span><span id="__span-78-23"><a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a><span class="w">    </span>name:<span class="w"> </span>discord
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>---
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>apiVersion:<span class="w"> </span>notification.toolkit.fluxcd.io/v1beta2
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>kind:<span class="w"> </span>Alert
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>metadata:
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">  </span>name:<span class="w"> </span>discord
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">  </span>namespace:<span class="w"> </span>bar
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>spec:
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="w">  </span>eventSeverity:<span class="w"> </span>info
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="w">  </span>eventSources:
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>GitRepository
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>Kustomization
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>ImageRepository
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>ImagePolicy
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>HelmRepository
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a><span class="w">  </span>-<span class="w"> </span>kind:<span class="w"> </span>HelmRelease
</span><span id="__span-79-21"><a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a><span class="w">    </span>name:<span class="w"> </span><span class="s1">&#39;*&#39;</span>
</span><span id="__span-79-22"><a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a><span class="w">  </span>providerRef:
</span><span id="__span-79-23"><a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a><span class="w">    </span>name:<span class="w"> </span>discord
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="activation-des-alertes-et-notifications">Activation des alertes et notifications</h3>
<h4 id="mise-en-place">Mise en place</h4>
<p>Poussons nos modifications dans notre dÃ©pÃ´t GitHub :</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;feat: setting up Discord alerting.&quot;</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>git<span class="w"> </span>push
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>flux<span class="w"> </span>reconcile<span class="w"> </span>kustomization<span class="w"> </span>flux-system<span class="w"> </span>--with-source
</span></code></pre></div>
<h3 id="tests">Tests</h3>
<p>VÃ©rifions la bonne crÃ©ation des alertes et notification providers :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="29:2"><input checked="checked" id="__tabbed_29_1" name="__tabbed_29" type="radio" /><input id="__tabbed_29_2" name="__tabbed_29" type="radio" /><div class="tabbed-labels"><label for="__tabbed_29_1">code</label><label for="__tabbed_29_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>providers,alerts<span class="w"> </span>-A
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>NAMESPACE<span class="w">   </span>NAME<span class="w">                                              </span>AGE<span class="w">     </span>READY<span class="w">   </span>STATUS
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>bar<span class="w">         </span>provider.notification.toolkit.fluxcd.io/discord<span class="w">   </span>3m16s<span class="w">   </span>True<span class="w">    </span>Initialized
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>foo<span class="w">         </span>provider.notification.toolkit.fluxcd.io/discord<span class="w">   </span>3m16s<span class="w">   </span>True<span class="w">    </span>Initialized
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>NAMESPACE<span class="w">   </span>NAME<span class="w">                                           </span>AGE<span class="w">     </span>READY<span class="w">   </span>STATUS
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>bar<span class="w">         </span>alert.notification.toolkit.fluxcd.io/discord<span class="w">   </span>3m16s<span class="w">   </span>True<span class="w">    </span>Initialized
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>foo<span class="w">         </span>alert.notification.toolkit.fluxcd.io/discord<span class="w">   </span>3m16s<span class="w">   </span>True<span class="w">    </span>Initialized
</span></code></pre></div>
</div>
</div>
</div>
<p>Testons leur bon fonctionnement : nous allons dÃ©sactiver les <em><em>'Image Policies'</em></em> de sorte qu'elles installent la version la plus ancienne des images.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="30:3"><input checked="checked" id="__tabbed_30_1" name="__tabbed_30" type="radio" /><input id="__tabbed_30_2" name="__tabbed_30" type="radio" /><input id="__tabbed_30_3" name="__tabbed_30" type="radio" /><div class="tabbed-labels"><label for="__tabbed_30_1">code</label><label for="__tabbed_30_2">'foo' image policy</label><label for="__tabbed_30_3">'foo' image policy</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>gsed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/order: asc/order: desc/&#39;</span><span class="w"> </span>apps/foo/agnhost.imagepolicy.yaml
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>gsed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/order: asc/order: desc/&#39;</span><span class="w"> </span>apps/bar/agnhost.imagepolicy.yaml
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;test: changing image policies to test Discord alerting.&quot;</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>git<span class="w"> </span>push
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>flux<span class="w"> </span>reconcile<span class="w"> </span>kustomization<span class="w"> </span>flux-system<span class="w"> </span>--with-source
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>---
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>apiVersion:<span class="w"> </span>image.toolkit.fluxcd.io/v1beta2
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>kind:<span class="w"> </span>ImagePolicy
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>metadata:
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="w">  </span>name:<span class="w"> </span>agnhost
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="w">  </span>namespace:<span class="w"> </span>foo
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>spec:
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="w">  </span>imageRepositoryRef:
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="w">    </span>name:<span class="w"> </span>agnhost
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a><span class="w">  </span>filterTags:
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a><span class="w">    </span>pattern:<span class="w"> </span><span class="s1">&#39;\d\.\d\d&#39;</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a><span class="w">    </span>extract:<span class="w"> </span><span class="s2">&quot;&quot;</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a><span class="w">  </span>policy:
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a><span class="w">    </span>numerical:
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a><span class="w">      </span>order:<span class="w"> </span>desc
</span></code></pre></div>
</div>
<div class="tabbed-block">
<hr />
<p>apiVersion: image.toolkit.fluxcd.io/v1beta2
kind: ImagePolicy
metadata:
  name: agnhost
  namespace: bar
spec:
  imageRepositoryRef:
    name: agnhost
  filterTags:
    pattern: '\d.\d\d'
    extract: ""
  policy:
    numerical:
      order: desc</p>
</div>
</div>
</div>
<p>Nous recevons les notifications suivantes dans les salons '#foo' et '#bar' :</p>
<p><img alt="Discord alerting for 'foo' app" src="../images/discord_alerting_foo.png" /></p>
<p><img alt="Discord alerting for 'bar' app" src="../images/discord_alerting_bar.png" /></p>
<div class="tabbed-set tabbed-alternate" data-tabs="31:2"><input checked="checked" id="__tabbed_31_1" name="__tabbed_31" type="radio" /><input id="__tabbed_31_2" name="__tabbed_31" type="radio" /><div class="tabbed-labels"><label for="__tabbed_31_1">code</label><label for="__tabbed_31_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;foo - &quot;</span><span class="p">;</span>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.items[].spec.containers[].image&#39;</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;bar - &quot;</span><span class="p">;</span>kubectl<span class="w"> </span>-n<span class="w"> </span>bar<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.items[].spec.containers[].image&#39;</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>foo<span class="w"> </span>-<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost:2.10
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>bar<span class="w"> </span>-<span class="w"> </span>registry.k8s.io/e2e-test-images/agnhost:2.10
</span></code></pre></div>
</div>
</div>
</div>
<h3 id="rollback">Rollback</h3>
<p>Le test est concluant, revenons Ã  la situation initiale oÃ¹ FluxCD s'assure de dÃ©ployer la version la plus rÃ©cente de l'image Docker.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="32:1"><input checked="checked" id="__tabbed_32_1" name="__tabbed_32" type="radio" /><div class="tabbed-labels"><label for="__tabbed_32_1">code</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/code/github&quot;</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">LOCAL_GITHUB_REPOS</span><span class="si">}</span>/k8s-kind-fluxcd
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>gsed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/order: desc/order: asc/&#39;</span><span class="w"> </span>apps/foo/agnhost.imagepolicy.yaml
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>gsed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/order: desc/order: asc/&#39;</span><span class="w"> </span>apps/bar/agnhost.imagepolicy.yaml
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;test: rollback to normal.&quot;</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>git<span class="w"> </span>push
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a>flux<span class="w"> </span>reconcile<span class="w"> </span>kustomization<span class="w"> </span>flux-system<span class="w"> </span>--with-source
</span></code></pre></div>
</div>
</div>
</div>
<p>Discord nous informe directement des modifications apportÃ©es Ã  nos applications :</p>
<p><img alt="Discord alerting for 'foo' rollback operation" src="../images/discord_alerting_foo_rollback.png" /></p>
<p><img alt="Discord alerting for 'bar' rollback operation" src="../images/discord_alerting_bar_rollback.png" /></p>
<p>Juste avant de pousser les modifications sur notre dÃ©pÃ´t GitHub et de forcer la rÃ©conciliation Flux, nous avions exÃ©cutÃ© la commande suivante dans un terminal pour surveiller le cycle de vie des pods concernÃ©s :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="33:2"><input checked="checked" id="__tabbed_33_1" name="__tabbed_33" type="radio" /><input id="__tabbed_33_2" name="__tabbed_33" type="radio" /><div class="tabbed-labels"><label for="__tabbed_33_1">code</label><label for="__tabbed_33_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--all-namespaces<span class="w"> </span>-l<span class="w"> </span><span class="s1">&#39;app in (foo, bar)&#39;</span><span class="w"> </span>-w
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>NAMESPACE<span class="w">   </span>NAME<span class="w">                   </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>bar<span class="w">         </span>bar-5f6dc76fcd-xrtk2<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>25m
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>foo<span class="w">         </span>foo-774bffc7f5-r7q6g<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>25m
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>foo<span class="w">         </span>foo-6b7d6f775c-fhtdj<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Pending<span class="w">   </span><span class="m">0</span><span class="w">          </span>0s
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>foo<span class="w">         </span>foo-6b7d6f775c-fhtdj<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Pending<span class="w">   </span><span class="m">0</span><span class="w">          </span>0s
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>foo<span class="w">         </span>foo-6b7d6f775c-fhtdj<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>ContainerCreating<span class="w">   </span><span class="m">0</span><span class="w">          </span>0s
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>foo<span class="w">         </span>foo-6b7d6f775c-fhtdj<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">             </span><span class="m">0</span><span class="w">          </span>1s
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a>foo<span class="w">         </span>foo-774bffc7f5-r7q6g<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>foo<span class="w">         </span>foo-774bffc7f5-r7q6g<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a>foo<span class="w">         </span>foo-774bffc7f5-r7q6g<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>foo<span class="w">         </span>foo-774bffc7f5-r7q6g<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a>foo<span class="w">         </span>foo-774bffc7f5-r7q6g<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a>bar<span class="w">         </span>bar-76848b7788-zc6r2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Pending<span class="w">             </span><span class="m">0</span><span class="w">          </span>0s
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a>bar<span class="w">         </span>bar-76848b7788-zc6r2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Pending<span class="w">             </span><span class="m">0</span><span class="w">          </span>0s
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a>bar<span class="w">         </span>bar-76848b7788-zc6r2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>ContainerCreating<span class="w">   </span><span class="m">0</span><span class="w">          </span>0s
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a>bar<span class="w">         </span>bar-76848b7788-zc6r2<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">             </span><span class="m">0</span><span class="w">          </span>1s
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a>bar<span class="w">         </span>bar-5f6dc76fcd-xrtk2<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a>bar<span class="w">         </span>bar-5f6dc76fcd-xrtk2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a>bar<span class="w">         </span>bar-5f6dc76fcd-xrtk2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a>bar<span class="w">         </span>bar-5f6dc76fcd-xrtk2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span><span id="__span-89-21"><a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a>bar<span class="w">         </span>bar-5f6dc76fcd-xrtk2<span class="w">   </span><span class="m">0</span>/1<span class="w">     </span>Terminating<span class="w">         </span><span class="m">0</span><span class="w">          </span>27m
</span></code></pre></div>
</div>
</div>
</div>
<p>Nous constatons que pour 'foo' comme pour 'bar', un nouveau pod est crÃ©Ã© et une fois opÃ©rationnel, le pod qu'il remplace est supprimÃ©.</p>
<p>Le version des images correspond Ã  nouveau la plus rÃ©cente des versions proposÃ©es :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="34:2"><input checked="checked" id="__tabbed_34_1" name="__tabbed_34" type="radio" /><input id="__tabbed_34_2" name="__tabbed_34" type="radio" /><div class="tabbed-labels"><label for="__tabbed_34_1">code</label><label for="__tabbed_34_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;foo - &quot;</span><span class="p">;</span>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.items[].spec.containers[].image&#39;</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;bar - &quot;</span><span class="p">;</span>kubectl<span class="w"> </span>-n<span class="w"> </span>bar<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.items[].spec.containers[].image&#39;</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<p><code>sh
foo - registry.k8s.io/e2e-test-images/agnhost:2.52
bar - registry.k8s.io/e2e-test-images/agnhost:2.52</code></p>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Il semblerait bien que pendant que nous rÃ©alisions nos tests de notifications Discord, la version 2.52 de l'image agnhost a Ã©tÃ© publiÃ©e.</p>
</div>
<p>VÃ©rifions Ã  nouveau la liste des versions proposÃ©es par le dÃ©pÃ´t des images 'agnhost' :</p>
<div class="tabbed-set tabbed-alternate" data-tabs="35:2"><input checked="checked" id="__tabbed_35_1" name="__tabbed_35" type="radio" /><input id="__tabbed_35_2" name="__tabbed_35" type="radio" /><div class="tabbed-labels"><label for="__tabbed_35_1">code</label><label for="__tabbed_35_2">output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>foo<span class="w"> </span>get<span class="w"> </span>imagerepository<span class="w"> </span>agnhost<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.lastScanResult.latestTags}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="o">[</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="w">  </span><span class="s2">&quot;2.9&quot;</span>,
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="w">  </span><span class="s2">&quot;2.52&quot;</span>,
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="w">  </span><span class="s2">&quot;2.51&quot;</span>,
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="w">  </span><span class="s2">&quot;2.50&quot;</span>,
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="w">  </span><span class="s2">&quot;2.48&quot;</span>,
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="w">  </span><span class="s2">&quot;2.47&quot;</span>,
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="w">  </span><span class="s2">&quot;2.45&quot;</span>,
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a><span class="w">  </span><span class="s2">&quot;2.44&quot;</span>,
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a><span class="w">  </span><span class="s2">&quot;2.43&quot;</span>,
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a><span class="w">  </span><span class="s2">&quot;2.41&quot;</span>
</span><span id="__span-92-12"><a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a><span class="o">]</span>
</span></code></pre></div>
</div>
</div>
</div>
<p>Effectivement, nous voyons bien la version 2.52 apparaÃ®tre dÃ©sormais <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M464 256a208 208 0 1 0-416 0 208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0 256 256 0 1 1-512 0zm130.7 57.9c-4.2-13.6 7.1-25.9 21.3-25.9h212.5c14.2 0 25.5 12.4 21.3 25.9C369 368.4 318.2 408 258.2 408s-110.8-39.6-127.5-94.1zM144.4 192a32 32 0 1 1 64 0 32 32 0 1 1-64 0zm165.8 21.7c-7.6 8.1-20.2 8.5-28.3.9s-8.5-20.2-.9-28.3c14.5-15.5 35.2-22.3 54.6-22.3s40.1 6.8 54.6 22.3c7.6 8.1 7.1 20.7-.9 28.3s-20.7 7.1-28.3-.9c-5.5-5.8-14.8-9.7-25.4-9.7s-19.9 3.8-25.4 9.7z"/></svg></span></p>
<hr />
<p>TODO</p>
<ul>
<li>Faire le schÃ©ma en mermaid avec les imageupdateautomations, imagepolicies, imagerepositories, gitrepositories etc</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>